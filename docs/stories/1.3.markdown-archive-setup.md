# Story 1.3: Markdown Archive Setup

## Status
Draft

## Story
**As a** developer,
**I want** a structured directory for storing markdown files extracted from the wiki,
**so that** I have a persistent, human-readable archive.

## Acceptance Criteria
1. `data/markdown-archive/` directory created
2. File naming convention: `{sanitized_article_title}.md`
3. Filename sanitization utility handles:
   - Spaces → underscores
   - Slashes → hyphens
   - Colons → hyphens
   - Special characters removed
   - Unicode normalized
4. Markdown files include frontmatter with metadata:
   ```yaml
   ---
   title: "Tyranids"
   wiki_id: "3"
   last_updated: "2024-09-20T14:18:31Z"
   word_count: 12453
   ---
   ```
5. Utility function `save_markdown_file(article: WikiArticle) -> Path` implemented
6. Unit tests verify filename sanitization edge cases

## Tasks / Subtasks

- [ ] Create data/markdown-archive directory structure (AC: 1)
  - [ ] Create data/markdown-archive/ directory
  - [ ] Add .gitkeep file to preserve directory in git
  - [ ] Update .gitignore to exclude markdown files but keep directory
- [ ] Implement filename sanitization utility (AC: 2, 3)
  - [ ] Create src/ingestion/filename_utils.py
  - [ ] Implement sanitize_filename(title: str) -> str function
  - [ ] Convert spaces to underscores
  - [ ] Convert slashes to hyphens
  - [ ] Convert colons to hyphens
  - [ ] Remove special characters (keep alphanumeric, underscore, hyphen)
  - [ ] Normalize unicode using unicodedata.normalize('NFKD', ...)
  - [ ] Add max filename length limit (255 characters)
  - [ ] Add type hints and docstring
- [ ] Implement markdown file saving utility (AC: 4, 5)
  - [ ] Create WikiArticle dataclass in src/ingestion/models.py
  - [ ] Define fields: title, wiki_id, last_updated, content, word_count
  - [ ] Implement save_markdown_file(article: WikiArticle) -> Path function
  - [ ] Generate YAML frontmatter with metadata
  - [ ] Combine frontmatter + content
  - [ ] Use pathlib.Path for cross-platform compatibility
  - [ ] Return Path object of saved file
  - [ ] Add error handling for file write failures
- [ ] Write unit tests for filename sanitization (AC: 6)
  - [ ] Create tests/unit/test_filename_utils.py
  - [ ] Test spaces to underscores conversion
  - [ ] Test slashes to hyphens conversion
  - [ ] Test colons to hyphens conversion
  - [ ] Test special character removal
  - [ ] Test unicode normalization (e.g., "Château" → "Chateau")
  - [ ] Test long filenames (>255 chars) are truncated
  - [ ] Test edge cases: empty string, all special chars, unicode only
- [ ] Write unit tests for markdown file saving
  - [ ] Create tests/unit/test_markdown_archive.py
  - [ ] Test save_markdown_file creates file with correct name
  - [ ] Test frontmatter is properly formatted YAML
  - [ ] Test content is preserved exactly
  - [ ] Test file path is returned correctly
  - [ ] Test overwrite behavior for existing files
- [ ] Verify all acceptance criteria met
  - [ ] Run all tests with `poetry run pytest`
  - [ ] Verify directory structure created
  - [ ] Verify .gitignore configured correctly

## Dev Notes

### Previous Story Insights
Story 1.2 completed successfully:
- Database schema implemented with WikiChunk model
- Alembic migrations configured
- Repository pattern established
- All tests passing

### Technical Notes
**[Source: Epic 1 Story 1.3]**

- Use `pathlib.Path` for cross-platform compatibility
- YAML frontmatter for metadata (human-readable)
- Git ignore `data/` directory (too large for version control)

### Filename Sanitization Requirements

**Safe characters:** Letters, numbers, underscore, hyphen
**Transformations:**
- Space → `_` (underscore)
- `/` → `-` (hyphen)
- `:` → `-` (hyphen)
- Unicode normalization to ASCII equivalents
- Remove all other special characters

**Example transformations:**
- "Blood Angels" → "Blood_Angels.md"
- "Chapter Master: Dante" → "Chapter_Master-_Dante.md"
- "Adeptus Mechanicus/Forge Worlds" → "Adeptus_Mechanicus-Forge_Worlds.md"

### YAML Frontmatter Format

```yaml
---
title: "Article Title"
wiki_id: "page_id_from_xml"
last_updated: "ISO 8601 timestamp"
word_count: 12453
---
```

### Coding Standards Reminders

**[Source: architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Use pathlib.Path for file operations (not os.path)
- Handle errors gracefully with appropriate exceptions

## Dev Agent Record

### Agent Model Used
[To be populated during implementation]

### Debug Log References
[To be populated during implementation]

### Completion Notes List
[To be populated during implementation]

### File List
[To be populated during implementation]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |

## QA Results
[To be populated by QA agent]

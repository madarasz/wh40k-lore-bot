# Story 1.3: Markdown Archive Setup

## Status
Ready for Review

## Story
**As a** developer,
**I want** a structured directory for storing markdown files extracted from the wiki,
**so that** I have a persistent, human-readable archive.

## Acceptance Criteria
1. `data/markdown-archive/` directory created
2. File naming convention: `{sanitized_article_title}.md`
3. Filename sanitization utility handles:
   - Spaces → underscores
   - Slashes → hyphens
   - Colons → hyphens
   - Special characters removed
   - Unicode normalized
4. Markdown files include frontmatter with metadata:
   ```yaml
   ---
   title: "Tyranids"
   wiki_id: "3"
   last_updated: "2024-09-20T14:18:31Z"
   word_count: 12453
   ---
   ```
5. Utility function `save_markdown_file(article: WikiArticle) -> Path` implemented
6. Unit tests verify filename sanitization edge cases

## Tasks / Subtasks

- [x] Create data/markdown-archive directory structure (AC: 1)
  - [x] Create data/markdown-archive/ directory
  - [x] Add .gitkeep file to preserve directory in git
  - [x] Update .gitignore to exclude markdown files but keep directory
- [x] Implement filename sanitization utility (AC: 2, 3)
  - [x] Create src/ingestion/filename_utils.py
  - [x] Implement sanitize_filename(title: str) -> str function
  - [x] Convert spaces to underscores
  - [x] Convert slashes to hyphens
  - [x] Convert colons to hyphens
  - [x] Remove special characters (keep alphanumeric, underscore, hyphen)
  - [x] Normalize unicode using unicodedata.normalize('NFKD', ...)
  - [x] Add max filename length limit (255 characters)
  - [x] Add type hints and docstring
- [x] Implement markdown file saving utility (AC: 4, 5)
  - [x] Create WikiArticle dataclass in src/ingestion/models.py
  - [x] Define fields: title, wiki_id, last_updated, content, word_count
  - [x] Implement save_markdown_file(article: WikiArticle) -> Path function
  - [x] Generate YAML frontmatter with metadata
  - [x] Combine frontmatter + content
  - [x] Use pathlib.Path for cross-platform compatibility
  - [x] Return Path object of saved file
  - [x] Add error handling for file write failures
- [x] Write unit tests for filename sanitization (AC: 6)
  - [x] Create tests/unit/test_filename_utils.py
  - [x] Test spaces to underscores conversion
  - [x] Test slashes to hyphens conversion
  - [x] Test colons to hyphens conversion
  - [x] Test special character removal
  - [x] Test unicode normalization (e.g., "Château" → "Chateau")
  - [x] Test long filenames (>255 chars) are truncated
  - [x] Test edge cases: empty string, all special chars, unicode only
- [x] Write unit tests for markdown file saving
  - [x] Create tests/unit/test_markdown_archive.py
  - [x] Test save_markdown_file creates file with correct name
  - [x] Test frontmatter is properly formatted YAML
  - [x] Test content is preserved exactly
  - [x] Test file path is returned correctly
  - [x] Test overwrite behavior for existing files
- [x] Verify all acceptance criteria met
  - [x] Run all tests with `poetry run pytest`
  - [x] Verify directory structure created
  - [x] Verify .gitignore configured correctly

## Dev Notes

### Previous Story Insights
Story 1.2 completed successfully:
- Database schema implemented with WikiChunk model
- Alembic migrations configured
- Repository pattern established
- All tests passing

### Technical Notes
**[Source: Epic 1 Story 1.3]**

- Use `pathlib.Path` for cross-platform compatibility
- YAML frontmatter for metadata (human-readable)
- Git ignore `data/` directory (too large for version control)

### Filename Sanitization Requirements

**Safe characters:** Letters, numbers, underscore, hyphen
**Transformations:**
- Space → `_` (underscore)
- `/` → `-` (hyphen)
- `:` → `-` (hyphen)
- Unicode normalization to ASCII equivalents
- Remove all other special characters

**Example transformations:**
- "Blood Angels" → "Blood_Angels.md"
- "Chapter Master: Dante" → "Chapter_Master-_Dante.md"
- "Adeptus Mechanicus/Forge Worlds" → "Adeptus_Mechanicus-Forge_Worlds.md"

### YAML Frontmatter Format

```yaml
---
title: "Article Title"
wiki_id: "page_id_from_xml"
last_updated: "ISO 8601 timestamp"
word_count: 12453
---
```

### Coding Standards Reminders

**[Source: architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Use pathlib.Path for file operations (not os.path)
- Handle errors gracefully with appropriate exceptions

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - No debugging required, all tests passed on first run after fixing linting issues.

### Completion Notes List
- All acceptance criteria met successfully
- Implemented comprehensive filename sanitization with edge case handling
- Created WikiArticle dataclass with validation in __post_init__
- Added 25 unit tests covering all functionality including edge cases
- All tests passing (65/65 total project tests)
- Linting (ruff) and type checking (mypy) passing with no errors
- Code coverage: filename_utils.py (100%), markdown_archive.py (88%), models.py (78%)
- Fixed minor linting issues: replaced Optional[Path] with Path | None, removed unused datetime import
- Git configuration updated to track directory structure but exclude markdown files
- Pull request created: https://github.com/madarasz/wh40k-lore-bot/pull/5

### File List
**New Files:**
- src/ingestion/filename_utils.py
- src/ingestion/models.py
- src/ingestion/markdown_archive.py
- tests/unit/test_filename_utils.py
- tests/unit/test_markdown_archive.py
- data/markdown-archive/.gitkeep

**Modified Files:**
- .gitignore (added markdown-archive directory tracking rules)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |
| 2025-12-27 | 1.1 | Story implementation completed - All ACs met, tests passing | James (Developer) |

## QA Results
[To be populated by QA agent]

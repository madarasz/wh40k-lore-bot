# Story 1.8: Chroma Vector Database Integration

## Status
Ready for Review

## Story
**As a** developer,
**I want** to store chunk embeddings in Chroma,
**so that** I can perform fast similarity searches.

## Acceptance Criteria
1. `src/rag/vector_store.py` created with `ChromaVectorStore` class
2. Chroma persistent client initialized:
   - Storage path: `data/chroma-db/`
   - Collection name: `wh40k-lore`
3. Collection metadata schema:
   - `article_title`: string
   - `section_path`: string
   - `chunk_index`: int
   - `faction`: string (optional, for filtering)
   - `era`: string (optional, for filtering)
   - `spoiler_flag`: bool
   - `content_type`: string
4. `add_chunks(chunks: List[Chunk], embeddings: List[np.ndarray])` method
5. Batch insertion: 1000 chunks per batch (Chroma performance)
6. `query(query_embedding: np.ndarray, n_results: int, filters: Dict) -> List[Chunk]` method
7. Metadata filtering support:
   - Filter by faction: `{"faction": "Space Marines"}`
   - Filter by era: `{"era": "Horus Heresy"}`
   - Exclude spoilers: `{"spoiler_flag": False}`
8. Distance metric: Cosine similarity
9. Unit tests with mock Chroma client
10. Integration test: Insert 100 chunks, query with filters

## Tasks / Subtasks

- [x] Create ChromaVectorStore class (AC: 1, 2)
  - [x] Create src/rag/vector_store.py
  - [x] Implement ChromaVectorStore class
  - [x] Initialize Chroma PersistentClient with path "data/chroma-db/"
  - [x] Create or get collection "wh40k-lore"
  - [x] Set distance metric to cosine similarity
  - [x] Add structlog logger instance
  - [x] Add type hints and docstring
- [x] Define collection metadata schema (AC: 3)
  - [x] Document metadata fields in docstring
  - [x] Define metadata typing (TypedDict)
  - [x] Ensure all required fields present
  - [x] Handle optional fields (faction, era)
  - [x] Validate metadata before insertion
- [x] Implement chunk insertion (AC: 4, 5)
  - [x] Implement add_chunks(chunks: List[Chunk], embeddings: List[np.ndarray])
  - [x] Validate chunks and embeddings have same length
  - [x] Generate unique IDs for each chunk (UUID)
  - [x] Convert Chunk objects to metadata dicts
  - [x] Batch insertions: 1000 chunks per batch
  - [x] Call collection.add(ids, embeddings, metadatas, documents)
  - [x] Log insertion progress
  - [x] Handle insertion errors gracefully
- [x] Implement query method (AC: 6, 8)
  - [x] Implement query(query_embedding, n_results, filters=None) -> List[Chunk]
  - [x] Call collection.query(query_embeddings, n_results, where=filters)
  - [x] Use cosine similarity for distance metric
  - [x] Convert results back to Chunk objects
  - [x] Return list of matching chunks with scores
  - [x] Handle empty results gracefully
- [x] Implement metadata filtering (AC: 7)
  - [x] Support faction filtering: {"faction": "value"}
  - [x] Support era filtering: {"era": "value"}
  - [x] Support spoiler filtering: {"spoiler_flag": false}
  - [x] Support compound filters (AND logic)
  - [x] Document filter syntax in docstring
  - [x] Add examples of filter usage
- [x] Add utility methods
  - [x] Implement count() -> int (total chunks in collection)
  - [x] Implement delete_collection() (for testing/reset)
  - [x] Implement get_by_id(chunk_id: str) -> Optional[Chunk]
  - [x] Add type hints and docstrings
- [x] Write unit tests (AC: 9)
  - [x] Create tests/unit/test_vector_store.py
  - [x] Mock Chroma client and collection
  - [x] Test add_chunks with valid data
  - [x] Test add_chunks with mismatched lengths (error)
  - [x] Test batch processing (>1000 chunks)
  - [x] Test query without filters
  - [x] Test query with faction filter
  - [x] Test query with era filter
  - [x] Test query with spoiler filter
  - [x] Test query with compound filters
  - [x] Test empty results
- [x] Write integration test (AC: 10)
  - [x] Create tests/integration/test_chroma_integration.py
  - [x] Test with real Chroma database
  - [x] Insert 100 test chunks with embeddings
  - [x] Query with various filters
  - [x] Verify results are relevant
  - [x] Verify cosine similarity scores
  - [x] Clean up test database after test
- [x] Verify all acceptance criteria met
  - [x] Run unit tests with `poetry run pytest tests/unit/`
  - [x] Run integration test with `poetry run pytest tests/integration/`
  - [x] Verify data persists across sessions
  - [x] Verify filtering works correctly

## Dev Notes

### Previous Story Insights
Story 1.7 completed:
- Embedding generation working
- 1536-dimensional embeddings from OpenAI
- Ready to store in vector database

### Technical Notes
**[Source: docs/epic-1-foundation-data-pipeline.md - Story 1.8]**

- Chroma embedded mode (no server required for MVP)
- Collection persists to disk automatically
- Future: Upgrade to Chroma server for production

### Chroma Setup

```python
import chromadb
from chromadb.config import Settings

# Initialize persistent client
client = chromadb.PersistentClient(path="data/chroma-db/")

# Get or create collection
collection = client.get_or_create_collection(
    name="wh40k-lore",
    metadata={"hnsw:space": "cosine"}  # Cosine similarity
)
```

### Adding Chunks to Chroma

```python
# Batch insertion
collection.add(
    ids=["chunk_1", "chunk_2", ...],
    embeddings=[[0.1, 0.2, ...], [0.3, 0.4, ...], ...],
    metadatas=[
        {
            "article_title": "Blood Angels",
            "section_path": "History > Founding",
            "chunk_index": 0,
            "faction": "Space Marines",
            "era": "Great Crusade",
            "spoiler_flag": False,
            "content_type": "lore"
        },
        ...
    ],
    documents=["chunk text 1", "chunk text 2", ...]
)
```

### Querying with Filters

```python
# Query with metadata filter
results = collection.query(
    query_embeddings=[[0.1, 0.2, ...]],
    n_results=10,
    where={
        "faction": "Space Marines",
        "spoiler_flag": False
    }
)

# Results structure
{
    "ids": [["chunk_1", "chunk_2", ...]],
    "distances": [[0.15, 0.23, ...]],
    "metadatas": [[{...}, {...}, ...]],
    "documents": [["text 1", "text 2", ...]]
}
```

### Filter Syntax

**Simple filter:**
```python
{"faction": "Space Marines"}
```

**Compound filter (AND):**
```python
{
    "faction": "Space Marines",
    "era": "Horus Heresy",
    "spoiler_flag": False
}
```

**Chroma also supports:**
- `$eq`, `$ne` (equal, not equal)
- `$in`, `$nin` (in list, not in list)
- `$gt`, `$gte`, `$lt`, `$lte` (comparisons)
- `$and`, `$or` (logical operators)

### Metadata Schema

```python
from typing import TypedDict, Optional

class ChunkMetadata(TypedDict):
    article_title: str
    section_path: str
    chunk_index: int
    faction: Optional[str]
    era: Optional[str]
    spoiler_flag: bool
    content_type: str
```

### Performance Considerations

**Batch size:**
- Chroma recommends batches of 1000 chunks
- Larger batches may cause memory issues
- Smaller batches increase overhead

**Index building:**
- Chroma builds HNSW index automatically
- Index builds in background
- First query may be slower (index warming)

### Coding Standards Reminders

**[Source: docs/architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Use TypedDict for structured metadata
- Handle errors gracefully (database failures)
- Log database operations for debugging

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries required

### Completion Notes List
- Implemented ChromaVectorStore class with full CRUD operations
- Added automatic conversion of compound filters to Chroma $and format for correct multi-filter queries
- All 36 vector store tests passing (23 unit + 13 integration)
- 100% code coverage for vector_store.py
- Full regression test suite passing (208 tests, 1 skipped)
- Chroma 1.4.0 successfully integrated with persistent storage

### File List
**Source Files:**
- [src/rag/vector_store.py](src/rag/vector_store.py) - ChromaVectorStore class with persistence, batching, filtering
- [src/utils/exceptions.py](src/utils/exceptions.py) - Added VectorStoreError exception

**Test Files:**
- [tests/unit/test_vector_store.py](tests/unit/test_vector_store.py) - 23 unit tests with mocked Chroma client
- [tests/integration/test_chroma_integration.py](tests/integration/test_chroma_integration.py) - 13 integration tests with real Chroma DB

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-29 | 1.1 | Story implementation completed | James (Dev Agent) |
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |

## QA Results
[To be populated by QA agent]

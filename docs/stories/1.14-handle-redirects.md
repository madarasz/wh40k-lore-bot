# Story 1.14: Handle Wiki Redirects

## Status
Ready for Review

## Epic
Epic 1: Foundation & Data Pipeline

## Dependencies
- Story 1.4: Wiki XML Parser (WikiXMLParser class, wikitext-to-markdown conversion)
- Story 1.3: Markdown Archive Setup (markdown archive output)
- Story 1.10: Complete Ingestion Pipeline (integration with downstream pipeline)

## Story
**As a** developer maintaining the data pipeline,
**I want** the wiki XML parser to detect and handle redirect pages using two-pass processing,
**so that** redirect pages are excluded from ingestion while internal links pointing to redirects are resolved to their canonical targets, improving data quality and eliminating useless chunks.

## Acceptance Criteria
1. First XML pass extracts all redirect mappings (source title -> target title) from pages with `<redirect title="..."/>` element
2. Redirect map is built before article processing begins (two-pass architecture)
3. During article processing (second pass), pages with `<redirect>` element are skipped entirely
4. During wikitext-to-markdown conversion, internal links (`[[Source]]`) pointing to redirect sources are resolved to their canonical targets (`[[Target]]`)
5. Links with display text (`[[Source|display]]`) preserve display text while resolving the target (`[[Target|display]]`)
6. HTML entities in redirect targets (e.g., `&#039;` -> `'`) are properly decoded
7. Logging captures redirect statistics: total redirects found, redirects skipped, links resolved during processing
8. CLI.md documentation updated to describe automatic redirect handling behavior
9. Unit tests cover redirect detection, link resolution, and edge cases
10. Integration test verifies end-to-end redirect handling with real XML sample

## Tasks / Subtasks

- [x] Task 1: Implement redirect map extraction (AC: 1, 2, 6, 7)
  - [x] Add `build_redirect_map()` method to `WikiXMLParser` class
  - [x] Stream XML with iterparse looking for `<redirect title="..."/>` elements
  - [x] Extract source title from `<title>` element and target from `<redirect title="..."/>` attribute
  - [x] Decode HTML entities in target titles using `html.unescape()`
  - [x] Return `dict[str, str]` mapping source -> target
  - [x] Add structured logging for redirect count statistics

- [x] Task 2: Modify XML parsing to skip redirect pages (AC: 3, 7)
  - [x] Update `_process_page_element()` to check for `<redirect>` element
  - [x] Return `None` (skip) for pages with redirect element
  - [x] Log skipped redirects at debug level
  - [x] Update parsing statistics to track redirects_skipped count

- [x] Task 3: Implement link resolution during conversion (AC: 4, 5)
  - [x] Add `redirect_map` parameter to `_convert_wikitext_to_markdown()` method
  - [x] Update `_convert_wiki_elements()` to accept redirect_map
  - [x] Before converting wikilink, check if `link_title` exists in redirect_map
  - [x] If redirect found, replace link_title with resolved target
  - [x] Preserve original display text if present (`[[Source|display]]` -> `[[Target|display]]`)
  - [x] Log resolved links at debug level

- [x] Task 4: Update parse_xml_export for two-pass architecture (AC: 1, 2, 3, 4, 7)
  - [x] Modify `parse_xml_export()` to automatically call `build_redirect_map()` first
  - [x] Store redirect_map as instance variable for use during processing
  - [x] Pass redirect_map through to markdown conversion
  - [x] Display redirect statistics in CLI output (redirects found, skipped, links resolved)
  - [x] Update docstrings to document automatic two-pass behavior

- [x] Task 5: Update CLI documentation (AC: 8)
  - [x] Document automatic redirect handling behavior in CLI.md
  - [x] Explain that redirect pages are automatically skipped
  - [x] Explain that links to redirect pages are automatically resolved

- [x] Task 6: Write unit tests (AC: 9)
  - [x] Test `build_redirect_map()` extracts redirects correctly
  - [x] Test HTML entity decoding in redirect targets
  - [x] Test redirect pages are skipped during processing
  - [x] Test link resolution replaces redirect sources with targets
  - [x] Test display text preservation during link resolution
  - [x] Test non-redirect links are unchanged
  - [x] Test empty redirect map (no redirects in XML)
  - [x] Test redirect to non-existent article (should still resolve)

- [x] Task 7: Write integration test (AC: 10)
  - [x] Create test XML fixture with redirect pages and articles linking to them
  - [x] Verify redirects are skipped in output
  - [x] Verify links in articles are resolved to canonical targets

## Dev Notes

### Relevant Source Tree
```
src/ingestion/
├── wiki_xml_parser.py     # WikiXMLParser class - PRIMARY modification target
├── models.py              # WikiArticle dataclass
src/cli/
├── parse_wiki.py          # CLI command to update
tests/unit/
├── test_wiki_xml_parser.py    # Existing parser tests
tests/integration/
├── test_xml_parsing.py        # Existing integration tests
```

### XML Redirect Structure
[Source: Investigation of warhammer40k_pages_current.xml]

Redirect pages have this structure:
```xml
<page>
  <title>Mankind</title>
  <ns>0</ns>
  <id>8782</id>
  <redirect title="Humans" />   <!-- This element indicates redirect -->
  <revision>
    <text>#REDIRECT [[Humans]]</text>
  </revision>
</page>
```

Key observations:
- 5,090 redirect pages out of 11,860 total ns=0 pages (43%)
- 2,525 unique redirect targets
- No chain redirects (redirect -> redirect) detected
- HTML entities present in some targets (e.g., `T&#039;au Empire`)

### Two-Pass Processing Architecture
```python
# Automatic two-pass processing (handled internally by parse_xml_export)
parser = WikiXMLParser()

# parse_xml_export now automatically:
# 1. Calls build_redirect_map() first (Pass 1)
# 2. Processes articles with redirect handling (Pass 2)
for article in parser.parse_xml_export(xml_path):
    # Redirect pages are automatically skipped
    # Links like [[Mankind]] are automatically resolved to [[Humans]]
    save_article(article)

# Statistics available after processing:
# parser.redirects_found - total redirect mappings extracted
# parser.redirects_skipped - redirect pages skipped during processing
# parser.links_resolved - internal links resolved to canonical targets
```

### Link Resolution Logic
```python
# In _convert_wiki_elements():
for wikilink in parsed.filter_wikilinks():
    link_title = str(wikilink.title).strip()

    # Resolve redirect if applicable
    if redirect_map and link_title in redirect_map:
        resolved_title = redirect_map[link_title]
        logger.debug("resolved_redirect_link",
                    original=link_title, resolved=resolved_title)
        link_title = resolved_title

    # Convert to markdown (preserving display text if present)
    if wikilink.text:
        display_text = str(wikilink.text)
        markdown_link = f"[{display_text}]({link_title})"
    else:
        markdown_link = f"[{link_title}]({link_title})"
```

### HTML Entity Decoding
```python
import html

# Target from XML: "T&#039;au Empire"
decoded_target = html.unescape(raw_target)
# Result: "T'au Empire"
```

### Existing Parser Method Signatures (before changes)
[Source: src/ingestion/wiki_xml_parser.py]
```python
def parse_xml_export(
    self,
    xml_path: str | Path,
    page_ids: list[str] | None = None,
) -> Iterator[WikiArticle]:

def _process_page_element(
    self, elem: etree._Element, page_id_set: set[str] | None
) -> WikiArticle | None:

def _convert_wikitext_to_markdown(self, wikitext: str) -> str:

def _convert_wiki_elements(
    self, parsed: mwparserfromhell.wikicode.Wikicode, text: str
) -> str:
```

### New Instance Variables to Add
```python
class WikiXMLParser:
    def __init__(self) -> None:
        # Existing
        self.articles_processed = 0
        self.articles_skipped = 0

        # New for redirect handling
        self.redirect_map: dict[str, str] = {}
        self.redirects_found = 0
        self.redirects_skipped = 0
        self.links_resolved = 0
```

### Testing

**[Source: docs/architecture/coding-standards.md]**

- Test file location: `tests/unit/test_wiki_xml_parser.py` (extend existing)
- Integration test: `tests/integration/test_xml_parsing.py` (extend existing)
- Use pytest fixtures for XML test data
- Mock file I/O for unit tests, use real fixture files for integration

**Test Fixtures Needed:**
```xml
<!-- tests/fixtures/redirect_test.xml -->
<mediawiki>
  <page>
    <title>Redirect Source</title>
    <ns>0</ns>
    <id>1</id>
    <redirect title="Target Article" />
    <revision><text>#REDIRECT [[Target Article]]</text></revision>
  </page>
  <page>
    <title>Article With Links</title>
    <ns>0</ns>
    <id>2</id>
    <revision><text>See [[Redirect Source]] for more info.</text></revision>
  </page>
  <page>
    <title>Target Article</title>
    <ns>0</ns>
    <id>3</id>
    <revision><text>This is the canonical article.</text></revision>
  </page>
</mediawiki>
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-02 | 1.0 | Story created based on redirect analysis | Bob (Scrum Master) |
| 2025-01-02 | 1.1 | Removed --skip-redirects flag; redirect handling is now automatic | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
_To be populated during implementation_

### Completion Notes List
- Implemented two-pass XML processing architecture for redirect handling
- Added `build_redirect_map()` method to extract redirect mappings in first pass
- Modified `_extract_page_data()` to skip redirect pages during processing
- Updated `_convert_wikitext_to_markdown()` and `_convert_wiki_elements()` to accept and use redirect_map for link resolution
- Added redirect statistics tracking (redirects_found, redirects_skipped, links_resolved)
- Updated CLI.md documentation with comprehensive redirect handling explanation
- Implemented 8 unit tests covering all redirect handling edge cases
- Implemented integration test verifying end-to-end redirect handling
- All 45 tests pass (26 existing + 8 new unit + 1 new integration + 10 existing integration)
- Linting and type checking pass successfully

### File List
**Modified:**
- [src/ingestion/wiki_xml_parser.py](src/ingestion/wiki_xml_parser.py) - Added redirect handling implementation
- [CLI.md](CLI.md) - Updated parse-wiki documentation with redirect handling details
- [tests/unit/test_wiki_xml_parser.py](tests/unit/test_wiki_xml_parser.py) - Added TestRedirectHandling class with 8 tests
- [tests/integration/test_xml_parsing.py](tests/integration/test_xml_parsing.py) - Added TestRedirectHandlingIntegration class

## QA Results
_To be populated by QA agent_

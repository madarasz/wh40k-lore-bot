# Story 1.13: Additional CLI Tools

## Status
Ready for Review

## Epic
Epic 1: Foundation & Data Pipeline

## Dependencies
- Story 1.1: Project Setup & Core Infrastructure (Click, structlog, dotenv)
- Story 1.2: Database Schema Design & Implementation (WikiChunk model, SQLite)
- Story 1.8: Chroma Vector Database Integration (ChromaVectorStore)
- Story 1.10: Complete Ingestion Pipeline (populated databases for testing)

## Story
**As a** developer or administrator,
**I want** additional CLI tools for analyzing archives, inspecting the vector database, and performing maintenance operations,
**so that** I can monitor data quality, debug issues, and manage the ingestion pipeline effectively.

## Acceptance Criteria
1. `poetry run stats-markdown` command created that outputs:
   - Total .md file count in archive
   - Top 10 smallest word count files (filename, word_count)
   - Top 10 largest word count files (filename, word_count)
   - Median word count across all files
2. `poetry run stats-db` command created that outputs:
   - Total chunk count in Chroma vector database
   - Top 10 smallest token count chunks ({wiki_page_id}_{chunk_index}, article_title)
   - Top 10 largest token count chunks ({wiki_page_id}_{chunk_index}, article_title)
   - Most recent `article_last_updated` date
3. `poetry run show-chunk <chunk_id>` command created that displays:
   - Chunk ID, article title, section path, wiki_page_id, chunk_index
   - Token count (calculated with tiktoken)
   - Full chunk text content
   - All metadata (faction, era, spoiler_flag, content_type, etc.)
4. `poetry run delete-chunk <chunk_id>` command created that:
   - Prompts for confirmation (unless `--force` flag provided)
   - Deletes chunk from both Chroma vector store AND SQLite WikiChunk table
   - Reports success/failure with deleted chunk details
5. `poetry run db-health` command created that outputs:
   - SQLite connection status
   - Chroma connection status
   - Collection name and chunk count
   - SQLite WikiChunk row count
   - Consistency check (Chroma count vs SQLite count match)
6. `poetry run purge-db` command created that:
   - Displays current chunk counts before deletion
   - Requires typing "DELETE ALL" to confirm (unless `--force` flag)
   - Deletes ALL chunks from both Chroma AND SQLite
   - Reports deletion counts
7. All commands registered in `pyproject.toml` under `[tool.poetry.scripts]`
8. All commands follow existing CLI patterns (Click framework, structlog logging, error handling)
9. Unit tests created for each command with mocked dependencies
10. Token counting uses tiktoken with `cl100k_base` encoding

## Tasks / Subtasks

- [x] Create stats-markdown command (AC: 1, 7, 8)
  - [x] Create `src/cli/stats_markdown.py`
  - [x] Implement `@click.command()` with `--archive-path` option
  - [x] Read markdown files and extract word_count from frontmatter
  - [x] Calculate statistics (count, top10 smallest/largest, median)
  - [x] Format output with clear sections
  - [x] Add to pyproject.toml scripts
- [x] Create stats-db command (AC: 2, 7, 8, 10)
  - [x] Create `src/cli/stats_db.py`
  - [x] Implement `@click.command()` with `--chroma-path` option
  - [x] Query all chunks from Chroma collection
  - [x] Calculate token counts using tiktoken
  - [x] Find top10 smallest/largest by token count
  - [x] Extract most recent article_last_updated
  - [x] Format output with clear sections
  - [x] Add to pyproject.toml scripts
- [x] Create show-chunk command (AC: 3, 7, 8, 10)
  - [x] Create `src/cli/show_chunk.py`
  - [x] Implement `@click.command()` with chunk_id argument
  - [x] Query Chroma by chunk ID
  - [x] Calculate token count with tiktoken
  - [x] Display all chunk fields and metadata
  - [x] Handle chunk not found error
  - [x] Add to pyproject.toml scripts
- [x] Create delete-chunk command (AC: 4, 7, 8)
  - [x] Create `src/cli/delete_chunk.py`
  - [x] Implement `@click.command()` with chunk_id argument and `--force` flag
  - [x] Display chunk info before deletion
  - [x] Prompt for confirmation (unless --force)
  - [x] Delete from Chroma vector store
  - [x] Delete from SQLite WikiChunk table
  - [x] Report success/failure
  - [x] Add to pyproject.toml scripts
- [x] Create db-health command (AC: 5, 7, 8)
  - [x] Create `src/cli/db_health.py`
  - [x] Implement `@click.command()` with `--chroma-path` and `--db-url` options
  - [x] Test SQLite connection
  - [x] Test Chroma connection
  - [x] Query counts from both stores
  - [x] Compare counts for consistency
  - [x] Display health report with status indicators
  - [x] Add to pyproject.toml scripts
- [x] Create purge-db command (AC: 6, 7, 8)
  - [x] Create `src/cli/purge_db.py`
  - [x] Implement `@click.command()` with `--chroma-path` and `--force` flags
  - [x] Display current chunk counts
  - [x] Require "DELETE ALL" confirmation (unless --force)
  - [x] Delete all chunks from Chroma collection
  - [x] Delete all rows from SQLite WikiChunk table
  - [x] Report deletion counts
  - [x] Add to pyproject.toml scripts
- [x] Write unit tests (AC: 9)
  - [x] Create `tests/unit/test_cli_stats_markdown.py`
  - [x] Create `tests/unit/test_cli_stats_db.py`
  - [x] Create `tests/unit/test_cli_show_chunk.py`
  - [x] Create `tests/unit/test_cli_delete_chunk.py`
  - [x] Create `tests/unit/test_cli_db_health.py`
  - [x] Create `tests/unit/test_cli_purge_db.py`
  - [x] Use CliRunner for testing
  - [x] Mock Chroma client and SQLAlchemy session
  - [x] Test error scenarios:
    - [x] Empty database (no chunks)
    - [x] Chunk not found (invalid ID)
    - [x] Invalid archive path
    - [x] Database connection failures (mocked)
    - [x] Confirmation prompt rejection (delete/purge)
- [x] Verify all acceptance criteria met
  - [x] Run all tests with `poetry run pytest`
  - [x] Test each CLI command manually
  - [x] Verify pyproject.toml entries correct

## Dev Notes

### Relevant Source Tree
```
src/cli/
├── ingest.py          # Example: full CLI command pattern
├── store.py           # Example: Chroma interaction
├── chunk.py           # Example: archive path handling
├── utils.py           # Shared CLI utilities
src/rag/
├── vector_store.py    # ChromaVectorStore class
src/ingestion/
├── markdown_loader.py # MarkdownLoader for archive access
src/models/
├── wiki_chunk.py      # WikiChunk ORM model
src/repositories/
├── chunk_repository.py # ChunkRepository for SQLite access
```

### CLI Pattern (from existing commands)
```python
import click
import structlog
from pathlib import Path
from dotenv import load_dotenv

load_dotenv()
logger = structlog.get_logger()

@click.command()
@click.option("--archive-path", type=click.Path(exists=True, path_type=Path),
              default=None, help="Path to markdown archive")
def command_name(archive_path: Path | None) -> None:
    """Command description.

    Detailed implementation notes.
    """
    try:
        # Implementation
        click.echo("Output")
    except KeyboardInterrupt:
        click.echo("Interrupted by user", err=True)
        raise click.Abort() from None
    except Exception as e:
        click.echo(f"Error: {e}", err=True)
        logger.error("command_failed", error=str(e), exc_info=True)
        raise click.Abort() from e
```

### Token Counting
```python
import tiktoken

encoder = tiktoken.get_encoding("cl100k_base")
token_count = len(encoder.encode(chunk_text))
```

### Chunk ID Format
- Format: `{wiki_page_id}_{chunk_index}` (e.g., "58_0", "58_1", "100_5")
- Generated by: `generate_chunk_id()` in `src/models/wiki_chunk.py:12-27`
- Parse: `wiki_page_id, chunk_index = chunk_id.rsplit("_", 1)`
- Deterministic IDs enable reliable upsert/delete operations for re-ingestion

### Default Paths (from existing CLI commands)
```python
DEFAULT_ARCHIVE_PATH = "data/markdown-archive"
DEFAULT_CHROMA_PATH = "data/chroma-db/"
DEFAULT_DB_URL = "sqlite+aiosqlite:///data/wh40k_lore_bot.db"
```

### Chroma Query by ID
```python
from src.rag.vector_store import ChromaVectorStore

store = ChromaVectorStore(storage_path=chroma_path)  # Note: storage_path, not persist_directory
result = store.collection.get(ids=[chunk_id], include=["documents", "metadatas"])
```

### Chroma Get All Chunks (for stats-db)
```python
# Get all chunks from Chroma collection
results = store.collection.get(include=["documents", "metadatas"])
# results["ids"] contains all chunk IDs
# results["documents"] contains all chunk texts
# results["metadatas"] contains all metadata dicts
```

### Existing Utility Methods
```python
# ChromaVectorStore already has:
store.count()  # Returns total chunk count
store.get_by_id(chunk_id)  # Returns WikiChunk or None
```

### SQLite Count Query (for db-health)
```python
from sqlalchemy import func, select
from src.models.wiki_chunk import WikiChunk

stmt = select(func.count()).select_from(WikiChunk)
result = await session.execute(stmt)
sqlite_count = result.scalar_one()
```

### Delete Operations
- Chroma: `store.collection.delete(ids=[chunk_id])` - direct collection access
- SQLite: `ChunkRepository.delete(chunk_id)` - already exists (src/repositories/chunk_repository.py:102)
- Both deletions must succeed for consistency; wrap in try/except to handle partial failures

### Purge All Operations
```python
# Chroma: delete entire collection and recreate
store.delete_collection()  # Already exists in ChromaVectorStore

# SQLite: delete all rows
from sqlalchemy import delete
stmt = delete(WikiChunk)
await session.execute(stmt)
await session.commit()
```

### pyproject.toml Entry Format
```toml
[tool.poetry.scripts]
stats-markdown = "src.cli.stats_markdown:stats_markdown"
stats-db = "src.cli.stats_db:stats_db"
show-chunk = "src.cli.show_chunk:show_chunk"
delete-chunk = "src.cli.delete_chunk:delete_chunk"
db-health = "src.cli.db_health:db_health"
purge-db = "src.cli.purge_db:purge_db"
```

### Testing
**[Source: docs/architecture/coding-standards.md]**
- Test file location: `tests/unit/test_cli_*.py`
- Use `click.testing.CliRunner` for CLI testing
- Mock external dependencies (Chroma, SQLAlchemy)
- Test success paths and error handling

```python
from click.testing import CliRunner
from unittest.mock import patch, MagicMock

class TestCommandName:
    def test_success(self):
        runner = CliRunner()
        with patch("src.cli.module.Dependency") as mock_dep:
            mock_dep.return_value = MagicMock()
            from src.cli.module import command_name
            result = runner.invoke(command_name, ["--option", "value"])
            assert result.exit_code == 0
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-31 | 1.0 | Story created | Bob (Scrum Master) |
| 2025-12-31 | 1.1 | Added dependencies section, added error test scenarios, added existing utility method references (count, get_by_id, delete), added SQLite count query pattern, added purge operations pattern, status changed to Ready | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- All tests pass: 288 passed, 1 skipped
- Ruff linting: All checks passed
- Mypy type checking: Success, no issues found

### Completion Notes List
- Created 6 new CLI commands following existing patterns (Click, structlog, error handling)
- All commands use tiktoken cl100k_base for token counting
- Commands handle both Chroma and SQLite stores for consistency
- Refactored commands to use helper functions to stay within complexity limits (PLR0912, PLR0915)
- Added 22 unit tests covering success paths, error scenarios, and edge cases
- All commands registered in pyproject.toml under [tool.poetry.scripts]

### File List
**New Source Files:**
- src/cli/stats_markdown.py (created)
- src/cli/stats_db.py (created)
- src/cli/show_chunk.py (created)
- src/cli/delete_chunk.py (created)
- src/cli/db_health.py (created)
- src/cli/purge_db.py (created)

**New Test Files:**
- tests/unit/test_cli_stats_markdown.py (created)
- tests/unit/test_cli_stats_db.py (created)
- tests/unit/test_cli_show_chunk.py (created)
- tests/unit/test_cli_delete_chunk.py (created)
- tests/unit/test_cli_db_health.py (created)
- tests/unit/test_cli_purge_db.py (created)

**Modified Files:**
- pyproject.toml (added 6 new script entries)

### Pull Request
https://github.com/madarasz/wh40k-lore-bot/pull/12

## QA Results
[To be populated by QA agent]

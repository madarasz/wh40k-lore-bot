# Story 1.1: Project Setup & Core Infrastructure

## Status
Draft

## Story
**As a** developer,
**I want** the project scaffolding, dependencies, and core infrastructure components set up,
**so that** I can begin building features on a solid foundation.

## Acceptance Criteria
1. Repository initialized with Poetry for dependency management
2. Core dependencies installed: **lxml, defusedxml, mwparserfromhell**, SQLAlchemy 2.0+, Alembic, structlog, python-dotenv, pytest
3. Development tools installed: **ruff** (linter and formatter), **mypy** (static type checking)
4. Project structure created following architecture
5. Environment configuration with `.env.template` file containing:
   - `DISCORD_BOT_TOKEN`
   - `OPENAI_API_KEY`
   - `DATABASE_URL`
   - `LOG_LEVEL`
6. Logging configured using structlog with JSON formatting
7. SQLite database initialized with Alembic migrations
8. `README.md` created with setup instructions
9. Pre-commit hooks configured (ruff, mypy)

## Tasks / Subtasks

- [ ] Initialize Poetry project (AC: 1)
  - [ ] Run `poetry init` with project metadata
  - [ ] Configure Python version 3.11+ in pyproject.toml
  - [ ] Set up package structure with src layout
- [ ] Install core dependencies (AC: 2)
  - [ ] Add lxml (5.0+) for XML parsing
  - [ ] Add defusedxml (0.7+) for secure XML parsing
  - [ ] Add mwparserfromhell for MediaWiki markup conversion
  - [ ] Add SQLAlchemy 2.0+ for ORM
  - [ ] Add Alembic 1.13+ for migrations
  - [ ] Add structlog 24.1+ for logging
  - [ ] Add python-dotenv 1.0+ for environment management
  - [ ] Add pytest 8.0+ for testing
- [ ] Install development tools (AC: 3)
  - [ ] Add ruff (0.1+) for linting and formatting
  - [ ] Add mypy (1.8+) for type checking
  - [ ] Add pytest-cov for coverage
  - [ ] Add pytest-asyncio for async testing
  - [ ] Add pre-commit framework
- [ ] Create project directory structure (AC: 4)
  - [ ] Create src/adapters/ for entry points
  - [ ] Create src/orchestration/ for central orchestrator
  - [ ] Create src/rag/ for RAG pipeline
  - [ ] Create src/llm/ for LLM layer
  - [ ] Create src/repositories/ for data access
  - [ ] Create src/services/ for supporting services
  - [ ] Create src/ingestion/ for data pipeline
  - [ ] Create src/models/ for domain models
  - [ ] Create src/utils/ for shared utilities
  - [ ] Create src/migrations/ for DB migrations
  - [ ] Create data/ directory (gitignored)
  - [ ] Create data/markdown-archive/ subdirectory
  - [ ] Create data/chroma-db/ subdirectory
  - [ ] Create tests/ directory with conftest.py
  - [ ] Create tests/unit/ subdirectory
  - [ ] Create tests/integration/ subdirectory
  - [ ] Create tests/fixtures/ subdirectory
  - [ ] Create config/ directory
  - [ ] Create scripts/ directory
  - [ ] Create deployment/ directory
- [ ] Configure environment template (AC: 5)
  - [ ] Create .env.template with all required variables
  - [ ] Document each environment variable
  - [ ] Add .env to .gitignore
- [ ] Configure structured logging (AC: 6)
  - [ ] Create src/utils/logger.py with structlog configuration
  - [ ] Set up JSON formatting for logs
  - [ ] Configure log levels from environment
  - [ ] Test logging configuration
- [ ] Initialize database with Alembic (AC: 7)
  - [ ] Run alembic init to create migrations structure
  - [ ] Configure alembic.ini for SQLite
  - [ ] Create initial migration for base schema
  - [ ] Test migration up/down
- [ ] Create README documentation (AC: 8)
  - [ ] Add project overview and description
  - [ ] Document prerequisites (Python 3.11+, Poetry)
  - [ ] Add setup instructions
  - [ ] Document environment configuration
  - [ ] Add development workflow instructions
- [ ] Configure pre-commit hooks (AC: 9)
  - [ ] Create .pre-commit-config.yaml
  - [ ] Add ruff for linting with --fix
  - [ ] Add ruff-format for formatting
  - [ ] Add mypy for type checking
  - [ ] Add bandit for security scanning
  - [ ] Install pre-commit hooks with `pre-commit install`
  - [ ] Test pre-commit hooks on sample file
- [ ] Configure pyproject.toml (AC: 3, 9)
  - [ ] Set ruff line-length to 100
  - [ ] Configure ruff mccabe max-complexity to 10
  - [ ] Configure ruff pylint max-statements to 50
  - [ ] Set mypy to strict mode
  - [ ] Configure test coverage targets
- [ ] Create .gitignore file
  - [ ] Add data/ directory
  - [ ] Add .env file
  - [ ] Add __pycache__/ and *.pyc
  - [ ] Add .pytest_cache/
  - [ ] Add .coverage and htmlcov/
  - [ ] Add .mypy_cache/
- [ ] Verify installation and configuration
  - [ ] Run `poetry install` successfully
  - [ ] Run `poetry run ruff check .` (should pass)
  - [ ] Run `poetry run mypy .` (should pass)
  - [ ] Run `poetry run pytest` (should find/run tests)
  - [ ] Run `pre-commit run --all-files` (should pass)

## Dev Notes

### Previous Story Insights
This is the first story in Epic 1, no previous story context available.

### Project Structure
**[Source: architecture/source-tree.md]**

The project follows a layered architecture pattern:

```
wh40k-lore-bot/
├── src/                                    # Application source
│   ├── adapters/                          # Entry points
│   │   ├── discord_adapter.py
│   │   ├── cli_adapter.py
│   │   └── api_adapter.py                 # Phase 3
│   │
│   ├── orchestration/                     # Central orchestrator
│   │   ├── query_orchestrator.py          # ⭐ Main
│   │   ├── query_validator.py
│   │   ├── rate_limiter.py
│   │   └── models.py
│   │
│   ├── rag/                               # RAG pipeline
│   │   ├── rag_engine.py
│   │   ├── hybrid_retrieval.py
│   │   ├── metadata_filter.py
│   │   ├── context_expander.py
│   │   └── fusion.py
│   │
│   ├── llm/                               # LLM layer
│   │   ├── llm_router.py
│   │   ├── base_provider.py
│   │   ├── providers/
│   │   │   ├── openai_provider.py
│   │   │   ├── gemini_provider.py         # Phase 2
│   │   │   ├── claude_provider.py         # Phase 2
│   │   │   ├── grok_provider.py           # Phase 2
│   │   │   └── mistral_provider.py        # Phase 2
│   │   └── response_formatter.py
│   │
│   ├── repositories/                      # Data access
│   │   ├── vector_repository.py
│   │   ├── bm25_repository.py
│   │   ├── query_log_repository.py
│   │   ├── trivia_repository.py
│   │   └── server_config_repository.py
│   │
│   ├── services/                          # Supporting
│   │   ├── query_logger.py
│   │   └── trivia_system.py
│   │
│   ├── ingestion/                         # Data pipeline
│   │   ├── wiki_xml_parser.py
│   │   ├── chunking_service.py
│   │   ├── metadata_extractor.py
│   │   ├── embedding_service.py
│   │   └── index_builder.py
│   │
│   ├── models/                            # Domain models
│   │   ├── wiki_chunk.py
│   │   ├── query_log.py
│   │   ├── trivia.py
│   │   ├── server_config.py
│   │   └── user_feedback.py
│   │
│   ├── utils/                             # Shared utilities
│   │   ├── logger.py
│   │   ├── config.py
│   │   ├── exceptions.py
│   │   └── metrics.py
│   │
│   ├── migrations/                        # DB migrations
│   │   └── versions/
│   │
│   ├── api/                               # Admin dashboard (Phase 3)
│   │   ├── main.py
│   │   ├── routes/
│   │   └── templates/
│   │
│   └── __main__.py                        # Entry point

├── tests/                                 # Test suite
│   ├── conftest.py
│   ├── unit/
│   ├── integration/
│   └── fixtures/

├── scripts/                               # Utility scripts
│   ├── parse_wiki_xml.sh
│   ├── rebuild_indexes.sh
│   ├── backup_databases.sh
│   └── migrate_database.sh

├── data/                                  # Data storage (gitignored)
│   ├── chroma-db/
│   ├── bm25-index/
│   ├── wh40k_lore_bot.db
│   ├── markdown-archive/                  # ⭐ Private sub-repo
│   ├── backups/
│   └── logs/

├── config/                                # Configuration
│   ├── .env.example
│   ├── wiki_urls.txt
│   └── personalities/

├── deployment/                            # Infrastructure
│   ├── systemd/
│   │   └── wh40k-lore-bot.service
│   ├── nginx/
│   └── monitoring/
```

**Import Conventions [Source: architecture/source-tree.md]:**
- Use absolute imports only
- Example: `from src.orchestration.query_orchestrator import QueryOrchestrator`

**Entry Points [Source: architecture/source-tree.md]:**
- Discord Bot: `poetry run python -m src`
- CLI Commands: `poetry run python -m src.adapters.cli_adapter`

### Technology Stack
**[Source: architecture/tech-stack.md]**

**Core Runtime:**
- Python 3.11.x (stable LTS, excellent library support)
- Poetry 1.7+ for dependency management

**Essential Dependencies for Story 1.1:**
- lxml 5.0+ - XML parsing (high-performance, standards-compliant)
- defusedxml 0.7+ - Secure XML parsing (protection against XML vulnerabilities)
- mwparserfromhell - MediaWiki markup to Markdown conversion
- SQLAlchemy 2.0+ - ORM with type-safety and async support
- Alembic 1.13+ - Database migrations (SQLAlchemy integration)
- structlog 24.1+ - Structured logging with JSON output
- python-dotenv 1.0+ - Environment variable management
- pytest 8.0+ - Testing framework

**Development Tools:**
- ruff 0.1+ - Fast linter and formatter (replaces flake8+black+isort)
- mypy 1.8+ - Static type checking
- pre-commit 3.6+ - Git hook framework
- pytest-cov 4.1+ - Code coverage
- pytest-asyncio 0.23+ - Async testing support

**Database:**
- SQLite 3.40+ (Python stdlib) - Embedded database, zero-config, perfect for single server

### Coding Standards
**[Source: architecture/coding-standards.md]**

**Style & Linting:**
- Linter: ruff (replaces flake8, black, isort)
- Line length: 100 characters
- Pre-commit hooks: REQUIRED

**Type Checking:**
- Type hints REQUIRED for all function signatures
- Tool: mypy in strict mode

**Naming Conventions:**
- Module/File: snake_case (e.g., `query_orchestrator.py`)
- Class: PascalCase (e.g., `QueryOrchestrator`)
- Function: snake_case (e.g., `def process_query()`)
- Variable: snake_case (e.g., `user_id`)
- Constant: UPPER_SNAKE_CASE (e.g., `MAX_RETRIES`)
- Private: _leading_underscore (e.g., `def _helper()`)

**Method and File Complexity Limits:**
- Methods: Max 50 statements
- Files: Max 500 statements
- Classes: Max 300 statements
- Cyclomatic complexity: Max 10

**Documentation:**
- Docstrings required for all public classes and functions
- Format: Google Style
- Type hints on all function signatures

**Import Organization:**
```python
# Standard library
import os
from datetime import datetime

# Third-party
import discord
from sqlalchemy.ext.asyncio import AsyncSession

# Local
from src.models.wiki_chunk import WikiChunk
```

### Pre-commit Configuration Template
**[Source: architecture/coding-standards.md]**

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.15
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: ['-c', 'pyproject.toml']
```

### Ruff Configuration
**[Source: architecture/coding-standards.md]**

```toml
[tool.ruff]
line-length = 100

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.pylint]
max-statements = 50
```

### Testing

**Testing Framework:**
- pytest 8.0+ as the primary testing framework
- pytest-cov for code coverage measurement
- pytest-asyncio for testing async code

**Test Structure:**
- tests/unit/ - Unit tests
- tests/integration/ - Integration tests
- tests/fixtures/ - Shared test fixtures
- tests/conftest.py - Pytest configuration and shared fixtures

**Coverage Requirements:**
- No specific guidance found in architecture docs for minimum coverage percentage

### Environment Variables
**[Source: Epic 1 Story 1.1 AC 5]**

Required environment variables:
- `DISCORD_BOT_TOKEN` - Discord bot authentication token
- `OPENAI_API_KEY` - OpenAI API key for embeddings and LLM
- `DATABASE_URL` - SQLite database file path (e.g., `sqlite:///data/wh40k_lore_bot.db`)
- `LOG_LEVEL` - Logging level (DEBUG, INFO, WARNING, ERROR)

### Project Structure Notes

**IMPORTANT DISCREPANCY NOTED:**
The Epic 1 Story 1.1 shows a simplified project structure with `src/common/` for shared utilities, while the architecture document (source-tree.md) specifies a more sophisticated structure with separate directories for `utils/`, `models/`, `repositories/`, etc.

**Resolution:** The architecture document (source-tree.md) is the authoritative source and should be followed. The epic description appears to be an earlier draft. The implementation should create the full directory structure as specified in source-tree.md.

## Dev Agent Record

### Agent Model Used
[To be populated by dev agent]

### Debug Log References
[To be populated by dev agent]

### Completion Notes List
[To be populated by dev agent]

### File List
[To be populated by dev agent]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | James (Dev Agent) |

## QA Results
[To be populated by QA agent]

# Story 2.2: Context Expander Implementation

## Status
Not Started

## Epic
Epic 2: Core RAG Query System

## Dependencies
- Story 2.1: Hybrid Retrieval Service Implementation (uses retrieved chunks)
- Existing `VectorRepository` for fetching linked article chunks
- Existing `WikiChunk` model with metadata.links field

## Story
**As a** developer,
**I want** a context expander that follows cross-references in chunk metadata to enrich context,
**so that** the LLM has access to related information beyond the initial retrieval results.

## Acceptance Criteria

### Core Functionality
1. `ContextExpander` class created in `src/rag/context_expander.py`
2. `expand_context()` method implementation:
   - Accepts List[WikiChunk] (initial retrieved chunks)
   - Accepts `expansion_depth: int` (default: 1, max: 2)
   - Returns expanded List[WikiChunk] with additional related chunks

### Depth-1 Expansion
3. Expansion algorithm (depth=1):
   - Extract all `metadata.links` (article titles) from initial chunks
   - Query `VectorRepository` to fetch chunks from linked articles
   - Limit: Max 2 additional chunks per link
   - Deduplication: Skip chunks already in results (by chunk_id)
   - Ranking: Append to end of list (preserve initial ranking)

### Depth-2 Expansion
4. Expansion algorithm (depth=2):
   - Perform depth=1 expansion
   - Extract links from depth=1 expanded chunks
   - Fetch chunks from secondary links (max 1 chunk per link)
   - Total expansion limit: Max 30 total chunks after expansion

### Configuration
5. Configuration via environment:
   - `CONTEXT_EXPANSION_ENABLED` (default: True)
   - `CONTEXT_EXPANSION_DEPTH` (default: 1)
   - `CONTEXT_EXPANSION_MAX_CHUNKS` (default: 30)

### Observability
6. Structured logging:
   - Initial chunk count
   - Links extracted count
   - Chunks added from expansion
   - Final chunk count
   - Expansion depth used

### Testing
7. Unit tests covering:
   - No expansion (depth=0 or disabled)
   - Depth=1 expansion with multiple links
   - Depth=2 expansion
   - Deduplication (linked chunk already in results)
   - Max chunk limit enforcement
   - Edge case: No links in metadata (no expansion)
   - Edge case: Linked articles not found in vector DB

## Tasks / Subtasks

- [ ] Task 1: Create ContextExpander class structure (AC: 1, 2)
  - [ ] Create `src/rag/context_expander.py`
  - [ ] Define `ContextExpander` class
  - [ ] Initialize with VectorRepository dependency
  - [ ] Create `expand_context()` method signature
  - [ ] Load configuration from environment

- [ ] Task 2: Implement depth=1 expansion (AC: 3)
  - [ ] Extract all links from initial chunks' metadata
  - [ ] Query VectorRepository for each linked article
  - [ ] Limit to 2 chunks per link
  - [ ] Implement deduplication by chunk_id
  - [ ] Append expanded chunks to end of list
  - [ ] Add structured logging

- [ ] Task 3: Implement depth=2 expansion (AC: 4)
  - [ ] Check if depth=2 requested
  - [ ] Extract links from depth=1 expanded chunks
  - [ ] Query VectorRepository for secondary links
  - [ ] Limit to 1 chunk per secondary link
  - [ ] Enforce max 30 total chunks limit
  - [ ] Add structured logging for depth=2

- [ ] Task 4: Add configuration support (AC: 5)
  - [ ] Load `CONTEXT_EXPANSION_ENABLED` from environment
  - [ ] Load `CONTEXT_EXPANSION_DEPTH` from environment
  - [ ] Load `CONTEXT_EXPANSION_MAX_CHUNKS` from environment
  - [ ] Document environment variables in `.env.example`
  - [ ] Return original chunks if expansion disabled

- [ ] Task 5: Add observability (AC: 6)
  - [ ] Log initial chunk count
  - [ ] Log number of unique links extracted
  - [ ] Log chunks added at each depth level
  - [ ] Log final chunk count
  - [ ] Log expansion depth used
  - [ ] Use structlog with context

- [ ] Task 6: Write unit tests (AC: 7)
  - [ ] Test expansion disabled (returns original chunks)
  - [ ] Test depth=0 (returns original chunks)
  - [ ] Test depth=1 with multiple links
  - [ ] Test depth=2 expansion
  - [ ] Test deduplication (linked chunk already in results)
  - [ ] Test max chunk limit enforcement
  - [ ] Test no links in metadata (no expansion occurs)
  - [ ] Test linked articles not found in vector DB
  - [ ] Mock VectorRepository

- [ ] Task 7: Integration testing
  - [ ] Test with real VectorRepository and test collection
  - [ ] Verify cross-reference following works end-to-end
  - [ ] Verify deduplication prevents duplicates
  - [ ] Verify expansion improves context quality

## Dev Notes

### Technical Background
- **Cross-Reference Value:** Expansion improves contextual understanding
  - Example: "Roboute Guilliman" → "Ultramarines", "Primarch"
- **Depth Guidance:** Depth=1 sufficient for most queries; depth=2 for complex multi-entity queries
- **Token Budget:** Total context limit prevents LLM token overflow
- **Ranking Preservation:** Expanded chunks are supplementary, not primary

### Expansion Algorithm Example
```python
async def expand_context(
    self,
    chunks: list[WikiChunk],
    expansion_depth: int = 1
) -> list[WikiChunk]:
    """
    Expand context by following cross-references.

    Args:
        chunks: Initial retrieved chunks
        expansion_depth: How many levels to expand (0-2)

    Returns:
        Expanded list of chunks with related content
    """
    if not self.enabled or expansion_depth == 0:
        return chunks

    expanded = chunks.copy()
    seen_ids = {chunk.chunk_id for chunk in chunks}

    # Depth 1: Expand from initial chunks
    links = self._extract_links(chunks)
    for link in links[:self.max_chunks]:
        related = await self.vector_repo.get_chunks_by_article(link, limit=2)
        for chunk in related:
            if chunk.chunk_id not in seen_ids:
                expanded.append(chunk)
                seen_ids.add(chunk.chunk_id)

    # Depth 2: Expand from depth-1 chunks
    if expansion_depth >= 2:
        depth1_chunks = expanded[len(chunks):]
        secondary_links = self._extract_links(depth1_chunks)
        for link in secondary_links:
            related = await self.vector_repo.get_chunks_by_article(link, limit=1)
            for chunk in related:
                if chunk.chunk_id not in seen_ids and len(expanded) < self.max_total:
                    expanded.append(chunk)
                    seen_ids.add(chunk.chunk_id)

    return expanded[:self.max_total]
```

### Link Extraction Logic
```python
def _extract_links(self, chunks: list[WikiChunk]) -> list[str]:
    """Extract unique article titles from chunk metadata links."""
    links = []
    for chunk in chunks:
        if chunk.metadata and chunk.metadata.get("links"):
            links.extend(chunk.metadata["links"])
    # Return unique links preserving order
    return list(dict.fromkeys(links))
```

### Environment Configuration
Add to `.env.example`:
```bash
# Context Expansion Configuration
CONTEXT_EXPANSION_ENABLED=true        # Enable/disable context expansion
CONTEXT_EXPANSION_DEPTH=1             # Expansion depth (0-2)
CONTEXT_EXPANSION_MAX_CHUNKS=30       # Maximum total chunks after expansion
```

### Relevant Source Tree
```
src/rag/
├── __init__.py                       # Export ContextExpander
├── context_expander.py               # NEW: ContextExpander class
├── hybrid_retrieval.py               # EXISTING: from Story 2.1
src/repositories/
├── vector_repository.py              # EXISTING: VectorRepository
src/models/
├── wiki_chunk.py                     # EXISTING: WikiChunk model
tests/unit/
├── test_context_expander.py          # NEW: Unit tests
tests/integration/
├── test_rag_pipeline.py              # EXTEND: Add expansion tests
```

### Testing Strategy
- **Unit Tests:** Mock VectorRepository to control linked chunk results
- **Integration Tests:** Use test Chroma collection with known cross-references
- **Edge Cases:** Test missing links, circular references, max limits

### Example Use Case
```
Initial Query: "Who is Roboute Guilliman?"
Initial Chunks: [Guilliman bio chunk 1, Guilliman bio chunk 2]
Extracted Links: ["Ultramarines", "Primarch", "Emperor of Mankind"]
Depth-1 Expansion: + 2 Ultramarines chunks, + 2 Primarch chunks, + 2 Emperor chunks
Final Context: 8 chunks (2 initial + 6 expanded)
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Story created from Epic 2 | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Pull Request
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

---

**Estimated Effort:** 2 hours

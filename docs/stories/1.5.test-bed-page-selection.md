# Story 1.5: Test Bed Page Selection (100-Page Dataset)

## Status
Draft

## Story
**As a** developer,
**I want** to create a curated list of ~100 wiki pages starting from Blood Angels and expanding to related pages,
**so that** I can fine-tune and test the RAG pipeline before processing the full 10,000+ page dataset.

## Acceptance Criteria
1. `src/ingestion/test_bed_builder.py` created with `TestBedBuilder` class
2. Starting page: **Blood Angels** (wiki page id: `58`)
3. Expansion strategy implements breadth-first traversal:
   - Start with seed page (Blood Angels)
   - Extract all internal wiki links from the page
   - Add linked pages to queue
   - Process queue until ~100 pages collected
   - Prioritize pages with most incoming links (hub pages)
4. `build_test_bed(xml_path: str, seed_page_id: str, target_count: int = 100) -> List[str]` method
5. Link extraction from MediaWiki markup:
   - Parse `[[Internal Link]]` and `[[Link|Display Text]]` patterns
   - Resolve link targets to wiki page IDs using XML lookup
   - Track link frequency for prioritization
6. Output saved to: `data/test-bed-pages.txt` (one page ID per line)
7. Include page titles as comments in output file for readability:
   ```
   # Blood Angels (seed)
   58
   # Sanguinius
   142
   # Horus Heresy
   89
   ...
   ```
8. Statistics logged:
   - Total pages selected
   - Depth of traversal from seed
   - Top 10 most-linked pages
   - Coverage by faction/topic
9. CLI command: `poetry run build-test-bed data/warhammer40k_pages_current.xml --seed-id 58 --count 100`
10. Unit tests verify link extraction and traversal logic
11. Integration test with real wiki XML

## Tasks / Subtasks

- [ ] Create TestBedBuilder class (AC: 1)
  - [ ] Create src/ingestion/test_bed_builder.py
  - [ ] Implement TestBedBuilder class
  - [ ] Add structlog logger instance
  - [ ] Add type hints and docstring
- [ ] Build title→ID mapping from XML (AC: 5)
  - [ ] Implement _build_title_to_id_map(xml_path: str) -> Dict[str, str]
  - [ ] First-pass scan of XML to build mapping
  - [ ] Use iterparse for memory efficiency
  - [ ] Filter for ns=0 pages only
  - [ ] Map normalized title → page ID
  - [ ] Handle title normalization (spaces, case)
- [ ] Implement breadth-first traversal (AC: 2, 3, 4)
  - [ ] Implement build_test_bed(xml_path, seed_page_id, target_count=100)
  - [ ] Initialize queue with seed page ID (58 - Blood Angels)
  - [ ] Track visited pages in set
  - [ ] Track incoming link counts per page
  - [ ] While queue not empty and count < target_count:
  - [ ] Pop page from queue
  - [ ] Extract links from page
  - [ ] Add unvisited linked pages to queue
  - [ ] Prioritize pages by incoming link count
  - [ ] Return list of selected page IDs
- [ ] Implement link extraction and resolution (AC: 5)
  - [ ] Reuse extract_internal_links from Story 1.4
  - [ ] Parse MediaWiki markup for [[...]] links
  - [ ] Extract link targets (handle [[Link|Display]] format)
  - [ ] Resolve link titles to page IDs using mapping
  - [ ] Track link frequency for hub page detection
- [ ] Implement output file generation (AC: 6, 7)
  - [ ] Create write_test_bed_file(page_ids: List[str], output_path: str)
  - [ ] Format: one page ID per line
  - [ ] Add comments with page titles for readability
  - [ ] Include "(seed)" marker for starting page
  - [ ] Save to data/test-bed-pages.txt
- [ ] Add statistics logging (AC: 8)
  - [ ] Track traversal depth from seed
  - [ ] Calculate coverage stats
  - [ ] Identify top 10 most-linked pages
  - [ ] Log faction/topic distribution if detectable
  - [ ] Log final statistics summary
- [ ] Create CLI command (AC: 9)
  - [ ] Create src/cli/build_test_bed.py
  - [ ] Use click for CLI framework
  - [ ] Add xml_path argument
  - [ ] Add --seed-id option (default: "58")
  - [ ] Add --count option (default: 100)
  - [ ] Add --output option (default: data/test-bed-pages.txt)
  - [ ] Display progress and stats to console
  - [ ] Add to pyproject.toml [tool.poetry.scripts]
- [ ] Write unit tests (AC: 10)
  - [ ] Create tests/unit/test_test_bed_builder.py
  - [ ] Test title→ID mapping construction
  - [ ] Test BFS traversal with mock data
  - [ ] Test link extraction and resolution
  - [ ] Test priority queue ordering (hub pages first)
  - [ ] Test target count limit enforcement
  - [ ] Test output file format
- [ ] Write integration test (AC: 11)
  - [ ] Create tests/integration/test_test_bed_builder.py
  - [ ] Test with real wiki XML sample
  - [ ] Verify ~100 pages selected
  - [ ] Verify Blood Angels is first page
  - [ ] Verify output file format
  - [ ] Verify related pages included
- [ ] Verify all acceptance criteria met
  - [ ] Run all tests with `poetry run pytest`
  - [ ] Test CLI command with real XML
  - [ ] Verify output file created correctly
  - [ ] Verify statistics are meaningful

## Dev Notes

### Previous Story Insights
Story 1.4 completed:
- WikiXMLParser available for XML processing
- extract_internal_links() function available
- MediaWiki to Markdown conversion working

### Technical Notes
**[Source: Epic 1 Story 1.5]**

- Use BFS (breadth-first search) to ensure diverse topic coverage near seed
- Track visited pages to avoid duplicates
- Page ID resolution requires first-pass XML scan to build title→ID mapping
- Priority queue based on incoming link count ensures important hub pages included
- Test bed enables faster iteration on chunking, embedding, and retrieval strategies

### BFS Traversal Algorithm

```python
from collections import deque, defaultdict

def build_test_bed(xml_path, seed_page_id, target_count=100):
    # Build title→ID mapping
    title_to_id = _build_title_to_id_map(xml_path)

    # BFS setup
    queue = deque([seed_page_id])
    visited = {seed_page_id}
    incoming_links = defaultdict(int)
    selected = [seed_page_id]

    while queue and len(selected) < target_count:
        page_id = queue.popleft()

        # Extract links from page
        links = extract_links_from_page(page_id, xml_path)

        # Add unvisited linked pages
        for link in links:
            linked_id = title_to_id.get(link)
            if linked_id and linked_id not in visited:
                visited.add(linked_id)
                queue.append(linked_id)
                selected.append(linked_id)
                incoming_links[linked_id] += 1

        # Reorder queue by incoming link count (hub pages first)
        queue = deque(sorted(queue, key=lambda x: incoming_links[x], reverse=True))

    return selected[:target_count]
```

### Expected Test Bed Composition

Starting from **Blood Angels (58)**:
- Direct links: Sanguinius, Primarch, Space Marines, Imperium
- Second degree: Horus Heresy, Great Crusade, Emperor
- Third degree: Other Legions, major characters, events

Expected coverage:
- Space Marines chapters: ~30%
- Horus Heresy era: ~25%
- Characters: ~20%
- Imperium/factions: ~15%
- Other lore: ~10%

### Coding Standards Reminders

**[Source: architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Use collections.deque for efficient queue operations
- Use defaultdict for counting
- Log progress at meaningful intervals

## Dev Agent Record

### Agent Model Used
[To be populated during implementation]

### Debug Log References
[To be populated during implementation]

### Completion Notes List
[To be populated during implementation]

### File List
[To be populated during implementation]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |

## QA Results
[To be populated by QA agent]

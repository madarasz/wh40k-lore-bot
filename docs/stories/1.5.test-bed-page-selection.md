# Story 1.5: Test Bed Page Selection (100-Page Dataset)

## Status
Ready for Review

## Story
**As a** developer,
**I want** to create a curated list of ~100 wiki pages starting from Blood Angels and expanding to related pages,
**so that** I can fine-tune and test the RAG pipeline before processing the full 10,000+ page dataset.

## Acceptance Criteria
1. `src/ingestion/test_bed_builder.py` created with `TestBedBuilder` class
2. Starting page: **Blood Angels** (wiki page id: `58`)
3. Expansion strategy implements breadth-first traversal:
   - Start with seed page (Blood Angels)
   - Extract all internal wiki links from the page
   - Add linked pages to queue
   - Process queue until ~100 pages collected
   - Prioritize pages with most incoming links (hub pages)
4. `build_test_bed(xml_path: str, seed_page_id: str, target_count: int = 100) -> List[str]` method
5. Link extraction from MediaWiki markup:
   - Parse `[[Internal Link]]` and `[[Link|Display Text]]` patterns
   - Resolve link targets to wiki page IDs using XML lookup
   - Track link frequency for prioritization
6. Output saved to: `data/test-bed-pages.txt` (one page ID per line)
7. Include page titles as comments in output file for readability:
   ```
   # Blood Angels (seed)
   58
   # Sanguinius
   142
   # Horus Heresy
   89
   ...
   ```
8. Statistics logged:
   - Total pages selected
   - Depth of traversal from seed
   - Top 10 most-linked pages
   - Coverage by faction/topic
9. CLI command: `poetry run build-test-bed data/warhammer40k_pages_current.xml --seed-id 58 --count 100`
10. Unit tests verify link extraction and traversal logic
11. Integration test with real wiki XML

## Tasks / Subtasks

- [x] Create TestBedBuilder class (AC: 1)
  - [x] Create src/ingestion/test_bed_builder.py
  - [x] Implement TestBedBuilder class
  - [x] Add structlog logger instance
  - [x] Add type hints and docstring
- [x] Build title→ID mapping from XML (AC: 5)
  - [x] Implement _build_title_to_id_map(xml_path: str) -> Dict[str, str]
  - [x] First-pass scan of XML to build mapping
  - [x] Use iterparse for memory efficiency
  - [x] Filter for ns=0 pages only
  - [x] Map normalized title → page ID
  - [x] Handle title normalization (spaces, case)
- [x] Implement breadth-first traversal (AC: 2, 3, 4)
  - [x] Implement build_test_bed(xml_path, seed_page_id, target_count=100)
  - [x] Initialize queue with seed page ID (58 - Blood Angels)
  - [x] Track visited pages in set
  - [x] Track incoming link counts per page
  - [x] While queue not empty and count < target_count:
  - [x] Pop page from queue
  - [x] Extract links from page
  - [x] Add unvisited linked pages to queue
  - [x] Prioritize pages by incoming link count
  - [x] Return list of selected page IDs
- [x] Implement link extraction and resolution (AC: 5)
  - [x] Reuse extract_internal_links from Story 1.4
  - [x] Parse MediaWiki markup for [[...]] links
  - [x] Extract link targets (handle [[Link|Display]] format)
  - [x] Resolve link titles to page IDs using mapping
  - [x] Track link frequency for hub page detection
- [x] Implement output file generation (AC: 6, 7)
  - [x] Create write_test_bed_file(page_ids: List[str], output_path: str)
  - [x] Format: one page ID per line
  - [x] Add comments with page titles for readability
  - [x] Include "(seed)" marker for starting page
  - [x] Save to data/test-bed-pages.txt
- [x] Add statistics logging (AC: 8)
  - [x] Track traversal depth from seed
  - [x] Calculate coverage stats
  - [x] Identify top 10 most-linked pages
  - [x] Log faction/topic distribution if detectable
  - [x] Log final statistics summary
- [x] Create CLI command (AC: 9)
  - [x] Create src/cli/build_test_bed.py
  - [x] Use click for CLI framework
  - [x] Add xml_path argument
  - [x] Add --seed-id option (default: "58")
  - [x] Add --count option (default: 100)
  - [x] Add --output option (default: data/test-bed-pages.txt)
  - [x] Display progress and stats to console
  - [x] Add to pyproject.toml [tool.poetry.scripts]
- [x] Write unit tests (AC: 10)
  - [x] Create tests/unit/test_test_bed_builder_unit.py
  - [x] Test title→ID mapping construction
  - [x] Test BFS traversal with mock data
  - [x] Test link extraction and resolution
  - [x] Test priority queue ordering (hub pages first)
  - [x] Test target count limit enforcement
  - [x] Test output file format
- [x] Write integration test (AC: 11)
  - [x] Create tests/integration/test_test_bed_builder.py
  - [x] Test with real wiki XML sample
  - [x] Verify ~100 pages selected
  - [x] Verify Blood Angels is first page
  - [x] Verify output file format
  - [x] Verify related pages included
- [x] Verify all acceptance criteria met
  - [x] Run all tests with `poetry run pytest`
  - [x] Test CLI command with real XML
  - [x] Verify output file created correctly
  - [x] Verify statistics are meaningful

## Dev Notes

### Previous Story Insights
Story 1.4 completed:
- WikiXMLParser available for XML processing
- extract_internal_links() function available
- MediaWiki to Markdown conversion working

### Technical Notes
**[Source: docs/epic-1-foundation-data-pipeline.md - Story 1.5]**

- Use BFS (breadth-first search) to ensure diverse topic coverage near seed
- Track visited pages to avoid duplicates
- Page ID resolution requires first-pass XML scan to build title→ID mapping
- Priority queue based on incoming link count ensures important hub pages included
- Test bed enables faster iteration on chunking, embedding, and retrieval strategies

### BFS Traversal Algorithm

```python
from collections import deque, defaultdict

def build_test_bed(xml_path, seed_page_id, target_count=100):
    # Build title→ID mapping
    title_to_id = _build_title_to_id_map(xml_path)

    # BFS setup
    queue = deque([seed_page_id])
    visited = {seed_page_id}
    incoming_links = defaultdict(int)
    selected = [seed_page_id]

    while queue and len(selected) < target_count:
        page_id = queue.popleft()

        # Extract links from page
        links = extract_links_from_page(page_id, xml_path)

        # Add unvisited linked pages
        for link in links:
            linked_id = title_to_id.get(link)
            if linked_id and linked_id not in visited:
                visited.add(linked_id)
                queue.append(linked_id)
                selected.append(linked_id)
                incoming_links[linked_id] += 1

        # Reorder queue by incoming link count (hub pages first)
        queue = deque(sorted(queue, key=lambda x: incoming_links[x], reverse=True))

    return selected[:target_count]
```

### Expected Test Bed Composition

Starting from **Blood Angels (58)**:
- Direct links: Sanguinius, Primarch, Space Marines, Imperium
- Second degree: Horus Heresy, Great Crusade, Emperor
- Third degree: Other Legions, major characters, events

Expected coverage:
- Space Marines chapters: ~30%
- Horus Heresy era: ~25%
- Characters: ~20%
- Imperium/factions: ~15%
- Other lore: ~10%

### Coding Standards Reminders

**[Source: docs/architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Use collections.deque for efficient queue operations
- Use defaultdict for counting
- Log progress at meaningful intervals

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None - No significant issues encountered during implementation

### Completion Notes List
- Successfully implemented TestBedBuilder class with BFS traversal algorithm
- Achieved 95% test coverage for test_bed_builder.py
- All 126 tests passing (17 unit + 7 integration tests for this story)
- CLI command `build-test-bed` registered and ready to use
- Link extraction reuses WikiXMLParser.extract_internal_links() from Story 1.4
- Title normalization handles both spaces and underscores for flexible matching
- Priority queue implementation prioritizes hub pages (most incoming links)
- Statistics logging tracks traversal depth and top linked pages
- Unit test file renamed to test_test_bed_builder_unit.py to avoid pytest naming conflict

### File List
**Source Files:**
- [src/ingestion/test_bed_builder.py](src/ingestion/test_bed_builder.py) - New file: TestBedBuilder class implementation
- [src/cli/build_test_bed.py](src/cli/build_test_bed.py) - New file: CLI command for building test bed
- [pyproject.toml](pyproject.toml) - Modified: Added build-test-bed script entry

**Test Files:**
- [tests/unit/test_test_bed_builder_unit.py](tests/unit/test_test_bed_builder_unit.py) - New file: Unit tests (17 tests)
- [tests/integration/test_test_bed_builder.py](tests/integration/test_test_bed_builder.py) - New file: Integration tests (7 tests)

### Pull Request
https://github.com/madarasz/wh40k-lore-bot/pull/6

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |
| 2025-12-27 | 1.1 | Story implemented and tested | James (Developer) |

## QA Results
[To be populated by QA agent]

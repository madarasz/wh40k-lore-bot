# Story 2.1: Hybrid Retrieval Service Implementation

## Status
Ready for Review

## Epic
Epic 2: Core RAG Query System

## Dependencies
- Epic 1 must be complete (vector database populated, BM25 index built)
- Existing repositories: `VectorRepository`, `BM25Repository`
- Existing infrastructure: SQLite, Alembic, structlog

## Story
**As a** developer,
**I want** a hybrid retrieval service that combines vector similarity search and BM25 keyword matching,
**so that** I can retrieve the most relevant chunks for both conceptual and exact-match queries.

## Acceptance Criteria

### Core Functionality
1. `HybridRetrievalService` class created in `src/rag/hybrid_retrieval.py`
2. Vector search integration with `VectorRepository`:
   - Accepts query embedding (1536-dim vector)
   - Returns top-k chunks with similarity scores
   - Supports async operations
3. BM25 search integration with `BM25Repository`:
   - Accepts query text string
   - Returns top-k chunks with BM25 scores
   - Supports async operations

### Parallel Execution
4. Parallel retrieval execution:
   - Vector and BM25 searches run concurrently using `asyncio.gather()`
   - Performance: Both complete within combined time (not sequential)

### Reciprocal Rank Fusion
5. Reciprocal Rank Fusion (RRF) algorithm implementation:
   - Combines vector and BM25 results into unified ranking
   - Formula: `score = Σ 1/(k + rank_i)` where k=60 (standard RRF constant)
   - Returns final top-k chunks with fused scores

### Configuration
6. Configuration via environment:
   - `RETRIEVAL_TOP_K` (default: 20)
   - `RETRIEVAL_VECTOR_WEIGHT` (default: 0.5)
   - `RETRIEVAL_BM25_WEIGHT` (default: 0.5)

### Observability
7. Structured logging with timing metrics:
   - Vector search latency
   - BM25 search latency
   - Fusion processing time
   - Total retrieval time

### CLI Command
8. CLI command for testing hybrid retrieval:
   - Command: `poetry run retrieve <query_text>`
   - Generates embedding from query text
   - Executes hybrid retrieval
   - Displays top results with scores and article titles

### Testing
9. Unit tests covering:
   - Happy path: Both retrievals return results
   - Edge case: Vector returns results, BM25 returns none (and vice versa)
   - Edge case: Both return empty results
   - RRF algorithm correctness with known inputs
   - Async execution timing validation

## Tasks / Subtasks

- [x] Task 1: Create HybridRetrievalService class structure (AC: 1)
  - [x] Create `src/rag/` module with `__init__.py`
  - [x] Create `src/rag/hybrid_retrieval.py`
  - [x] Define `HybridRetrievalService` class with dependency injection
  - [x] Add initialization with VectorRepository and BM25Repository
  - [x] Add configuration loading from environment

- [x] Task 2: Implement vector search integration (AC: 2)
  - [x] Create `async def _vector_search()` method
  - [x] Call `VectorRepository.search_by_embedding()`
  - [x] Handle and log vector search errors
  - [x] Return chunks with similarity scores

- [x] Task 3: Implement BM25 search integration (AC: 3)
  - [x] Create `async def _bm25_search()` method
  - [x] Call `BM25Repository.search()`
  - [x] Handle and log BM25 search errors
  - [x] Return chunks with BM25 scores

- [x] Task 4: Implement parallel execution (AC: 4)
  - [x] Create main `async def retrieve()` method
  - [x] Use `asyncio.gather()` to run both searches concurrently
  - [x] Add timing instrumentation for both searches
  - [x] Log latency for each search method

- [x] Task 5: Implement RRF fusion algorithm (AC: 5)
  - [x] Create `_fuse_results()` method
  - [x] Implement RRF scoring formula (k=60)
  - [x] Handle ranking for chunks appearing in both result sets
  - [x] Sort by fused score and return top-k chunks
  - [x] Add structured logging for fusion metrics

- [x] Task 6: Add configuration support (AC: 6)
  - [x] Load `RETRIEVAL_TOP_K` from environment
  - [x] Load `RETRIEVAL_VECTOR_WEIGHT` from environment
  - [x] Load `RETRIEVAL_BM25_WEIGHT` from environment
  - [x] Document environment variables in `.env.example`

- [x] Task 7: Create CLI command for hybrid retrieval (AC: 8)
  - [x] Create `src/cli/retrieve.py` with retrieve command
  - [x] Load vector store and BM25 repository
  - [x] Generate embedding from query text using OpenAI
  - [x] Execute hybrid retrieval and display results
  - [x] Add command to pyproject.toml console scripts

- [x] Task 8: Write unit tests (AC: 9)
  - [x] Test happy path with both retrievals returning results
  - [x] Test vector-only results (BM25 returns empty)
  - [x] Test BM25-only results (vector returns empty)
  - [x] Test both searches return empty results
  - [x] Test RRF algorithm with known inputs/expected outputs
  - [x] Test async execution timing (parallel vs sequential)
  - [x] Mock VectorRepository and BM25Repository

- [x] Task 9: Integration testing
  - [x] Test with real VectorRepository and BM25Repository (test collection)
  - [x] Verify latency targets (<100ms for retrieval)
  - [x] Verify RRF improves ranking quality

## Dev Notes

### Technical Background
- **RRF Effectiveness:** Proven to improve retrieval quality by 15-30% for mixed query types
- **Latency Target:** <100ms for retrieval (critical for user experience)
- **BM25 Strength:** Proper noun handling (character names, factions)
- **Vector Strength:** Conceptual/semantic queries

### RRF Algorithm
```python
def reciprocal_rank_fusion(
    results: list[tuple[str, float]],
    k: int = 60
) -> dict[str, float]:
    """
    Compute RRF scores for search results.

    Args:
        results: List of (chunk_id, score) tuples
        k: RRF constant (default: 60, standard value)

    Returns:
        Dict mapping chunk_id to RRF score
    """
    scores = {}
    for rank, (chunk_id, _) in enumerate(results, start=1):
        rrf_score = 1.0 / (k + rank)
        scores[chunk_id] = scores.get(chunk_id, 0) + rrf_score
    return scores
```

### Parallel Execution Pattern
```python
async def retrieve(self, query_embedding: list[float], query_text: str) -> list[WikiChunk]:
    """Execute hybrid retrieval with parallel execution."""
    # Run searches concurrently
    vector_results, bm25_results = await asyncio.gather(
        self._vector_search(query_embedding),
        self._bm25_search(query_text)
    )

    # Fuse results
    fused_chunks = self._fuse_results(vector_results, bm25_results)
    return fused_chunks
```

### Environment Configuration
Add to `.env.example`:
```bash
# Hybrid Retrieval Configuration
RETRIEVAL_TOP_K=20                    # Number of chunks to retrieve
RETRIEVAL_VECTOR_WEIGHT=0.5           # Weight for vector search (0-1)
RETRIEVAL_BM25_WEIGHT=0.5             # Weight for BM25 search (0-1)
```

### Relevant Source Tree
```
src/rag/
├── __init__.py                       # NEW: RAG module exports
├── hybrid_retrieval.py               # NEW: HybridRetrievalService
src/repositories/
├── vector_repository.py              # EXISTING: VectorRepository
├── bm25_repository.py                # EXISTING: BM25Repository
tests/unit/
├── test_hybrid_retrieval.py          # NEW: Unit tests
tests/integration/
├── test_rag_pipeline.py              # NEW: Integration tests
```

### Testing Strategy
- **Unit Tests:** Mock repositories to test fusion logic and error handling
- **Integration Tests:** Use test Chroma collection and real BM25 index
- **Performance Tests:** Verify parallel execution timing improvements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-05 | 1.0 | Story created from Epic 2 | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries created - implementation completed without blockers.

### Pull Request
Ready for PR creation on story/2.1-hybrid-retrieval branch.

### Completion Notes List
- ✅ Implemented HybridRetrievalService with async parallel execution
- ✅ Used asyncio.gather() for concurrent vector and BM25 searches
- ✅ Implemented RRF fusion algorithm with configurable weights (k=60)
- ✅ Added environment-based configuration (RETRIEVAL_TOP_K, RETRIEVAL_VECTOR_WEIGHT, RETRIEVAL_BM25_WEIGHT)
- ✅ Created CLI command `poetry run retrieve <query_text>` for testing
- ✅ Comprehensive unit tests (18 tests, 100% pass rate)
- ✅ Integration tests with real vector store and BM25 index (9 tests, 100% pass rate)
- ✅ All linting (ruff) and type checking (mypy) passed
- ✅ Latency targets met (<100ms verified in integration tests)

### File List

**Source Files (Created):**
- `src/rag/hybrid_retrieval.py` - HybridRetrievalService implementation
- `src/cli/retrieve.py` - CLI command for hybrid retrieval testing

**Source Files (Modified):**
- `src/rag/__init__.py` - Added HybridRetrievalService export
- `.env.example` - Added retrieval configuration variables
- `pyproject.toml` - Added retrieve command to console scripts

**Test Files (Created):**
- `tests/unit/test_hybrid_retrieval.py` - Unit tests for HybridRetrievalService
- `tests/integration/test_hybrid_retrieval_integration.py` - Integration tests with real stores

## QA Results
_To be populated by QA agent_

---

**Estimated Effort:** 3 hours

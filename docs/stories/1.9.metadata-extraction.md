# Story 1.9: Metadata Extraction from Content

## Status
Ready for Review

## Story
**As a** developer,
**I want** to extract metadata (faction, era, character names, links) from chunk content,
**so that** I can enable rich filtering and enhance retrieval relevance.

## Acceptance Criteria
1. `src/ingestion/metadata_extractor.py` created with `MetadataExtractor` class
2. Faction detection:
   - Keyword matching from predefined list: `FACTIONS = ["Space Marines", "Tyranids", "Orks", ...]`
   - Case-insensitive matching
   - Return most frequent faction mentioned in chunk
3. Era detection:
   - Keyword matching: `ERAS = ["Great Crusade", "Horus Heresy", "Age of Apostasy", ...]`
   - Return all eras mentioned
4. Character name extraction:
   - Use internal wiki links: `[[Roboute Guilliman]]` → "Roboute Guilliman"
   - Limit to top 5 most mentioned
5. Content type classification:
   - "lore" (default)
   - "military" (keywords: battle, war, tactics)
   - "technology" (keywords: weapon, armor, vehicle)
   - "character" (if character names dominate)
6. Spoiler detection:
   - Keyword matching: "spoiler", "recent lore", "9th edition", "10th edition"
   - Default: `False` (Fandom wiki is canon, not spoilers)
7. Source book extraction:
   - Regex for book titles in references: "Codex: Space Marines", "Horus Heresy: Betrayal"
8. `extract_metadata(chunk: Chunk) -> Dict` method returns all metadata fields
9. Unit tests with sample chunks covering each detection case
10. Integration test with real wiki chunks

## Tasks / Subtasks

- [x] Create MetadataExtractor class (AC: 1)
  - [x] Create src/ingestion/metadata_extractor.py
  - [x] Implement MetadataExtractor class
  - [x] Add structlog logger instance
  - [x] Add type hints and docstring
- [x] Define faction and era constants (AC: 2, 3)
  - [x] Create src/common/constants.py
  - [x] Define FACTIONS list with major factions:
    - Space Marines, Chaos Space Marines, Imperial Guard
    - Tyranids, Orks, Eldar, Dark Eldar, Tau
    - Necrons, Adeptus Mechanicus, Sisters of Battle
    - (Add more from lore knowledge)
  - [x] Define ERAS list with major timeline periods:
    - Age of Terra, Age of Strife, Great Crusade
    - Horus Heresy, The Scouring, Age of Redemption
    - Age of Apostasy, Age of Forging, Time of Ending
    - (Add more from lore knowledge)
- [x] Implement faction detection (AC: 2)
  - [x] Implement _detect_faction(text: str) -> str | None
  - [x] Convert text to lowercase for matching
  - [x] Search for each faction keyword in text
  - [x] Count occurrences of each faction
  - [x] Return most frequent faction (or None)
  - [x] Handle faction aliases (e.g., "Astra Militarum" = "Imperial Guard")
- [x] Implement era detection (AC: 3)
  - [x] Implement _detect_eras(text: str) -> list[str]
  - [x] Convert text to lowercase for matching
  - [x] Search for each era keyword in text
  - [x] Return all eras mentioned
  - [x] Deduplicate results
- [x] Implement character name extraction (AC: 4)
  - [x] Implement _extract_character_names(text: str) -> list[str]
  - [x] Extract wiki links from markdown: [[Name]]
  - [x] Use regex: r'\[\[([^\]|]+)(?:\|[^\]]+)?\]\]'
  - [x] Filter for likely character names (proper nouns)
  - [x] Count mentions of each character
  - [x] Return top 5 most mentioned
- [x] Implement content type classification (AC: 5)
  - [x] Implement _classify_content_type(text: str, character_names: list[str]) -> str
  - [x] Define keyword sets for each type:
    - military: ["battle", "war", "tactics", "campaign", "siege"]
    - technology: ["weapon", "armor", "vehicle", "tech", "equipment"]
    - character: (high character name density)
  - [x] Count keyword matches for each type
  - [x] Return type with highest score
  - [x] Default to "lore" if no clear match
- [x] Implement spoiler detection (AC: 6)
  - [x] Implement _detect_spoiler(text: str) -> bool
  - [x] Define spoiler keywords:
    - "spoiler", "recent lore", "latest edition"
    - "9th edition", "10th edition", "current timeline"
  - [x] Search for keywords (case-insensitive)
  - [x] Return True if any found, False otherwise
  - [x] Default: False
- [x] Implement source book extraction (AC: 7)
  - [x] Implement _extract_source_books(text: str) -> list[str]
  - [x] Define regex patterns for book titles:
    - r'Codex:\s*([^,.\n]+)'
    - r'Horus Heresy:\s*([^,.\n]+)'
    - r'Index:\s*([^,.\n]+)'
    - r'White Dwarf\s+(\d+)'
  - [x] Extract all matches
  - [x] Deduplicate and clean results
  - [x] Return list of source books
- [x] Implement main extraction method (AC: 8)
  - [x] Implement extract_metadata(chunk: Chunk) -> dict[str, Any]
  - [x] Call all detection methods
  - [x] Combine results into metadata dict
  - [x] Include fields:
    - faction: str | None
    - eras: list[str]
    - character_names: list[str]
    - content_type: str
    - spoiler_flag: bool
    - source_books: list[str]
  - [x] Return complete metadata dict
- [x] Write unit tests (AC: 9)
  - [x] Create tests/unit/test_metadata_extractor.py
  - [x] Test faction detection with various chunks
  - [x] Test era detection
  - [x] Test character name extraction from wiki links
  - [x] Test content type classification (each type)
  - [x] Test spoiler detection (true and false cases)
  - [x] Test source book extraction
  - [x] Test extract_metadata returns all fields
  - [x] Test edge cases (empty text, no matches)
- [x] Write integration test (AC: 10)
  - [x] Create tests/integration/test_metadata_extraction.py
  - [x] Test with real wiki chunks
  - [x] Verify faction detection accuracy
  - [x] Verify character names extracted correctly
  - [x] Log metadata extraction statistics
- [x] Verify all acceptance criteria met
  - [x] Run all tests with `poetry run pytest`
  - [x] Test with sample chunks from various factions
  - [x] Verify metadata quality

## Dev Notes

### Previous Story Insights
Story 1.8 completed:
- Chroma vector store ready
- Metadata schema defined
- Ready to populate metadata fields

### Technical Notes
**[Source: docs/epic-1-foundation-data-pipeline.md - Story 1.9]**

- Simple keyword-based approach (no LLM needed for MVP)
- Faction/era lists maintained in `src/common/constants.py`
- Character names extracted from internal links (reliable)

### Faction List (Sample)

```python
FACTIONS = [
    # Imperium
    "Space Marines", "Adeptus Astartes",
    "Imperial Guard", "Astra Militarum",
    "Adeptus Mechanicus",
    "Adeptus Custodes",
    "Sisters of Battle", "Adepta Sororitas",
    "Imperial Navy",
    "Inquisition",

    # Chaos
    "Chaos Space Marines",
    "Death Guard",
    "Thousand Sons",
    "World Eaters",
    "Emperor's Children",
    "Chaos Daemons",

    # Xenos
    "Tyranids",
    "Orks",
    "Eldar", "Aeldari",
    "Dark Eldar", "Drukhari",
    "Tau", "T'au Empire",
    "Necrons",
    "Genestealer Cults",

    # Add more...
]
```

### Era List (Sample)

```python
ERAS = [
    "Age of Terra",
    "Age of Strife",
    "Unification Wars",
    "Great Crusade",
    "Horus Heresy",
    "The Scouring",
    "Age of Redemption",
    "Age of Apostasy",
    "Age of Forging",
    "Time of Ending",
    "Indomitus Crusade",
    # Add more...
]
```

### Character Name Extraction

```python
import re

def extract_character_names(text: str) -> List[str]:
    # Extract wiki links: [[Name]] or [[Name|Display]]
    pattern = r'\[\[([^\]|]+)(?:\|[^\]]+)?\]\]'
    matches = re.findall(pattern, text)

    # Count mentions
    from collections import Counter
    counter = Counter(matches)

    # Return top 5
    return [name for name, count in counter.most_common(5)]
```

### Content Type Classification

```python
CONTENT_TYPE_KEYWORDS = {
    "military": ["battle", "war", "warfare", "campaign", "siege", "tactics", "strategy"],
    "technology": ["weapon", "armor", "vehicle", "tech", "equipment", "bolter", "power armor"],
}

def classify_content_type(text: str, character_names: List[str]) -> str:
    text_lower = text.lower()

    # Check character density
    if len(character_names) >= 3:
        return "character"

    # Score each type
    scores = {}
    for content_type, keywords in CONTENT_TYPE_KEYWORDS.items():
        scores[content_type] = sum(1 for kw in keywords if kw in text_lower)

    # Return type with highest score
    if max(scores.values()) > 0:
        return max(scores, key=scores.get)

    return "lore"  # Default
```

### Source Book Regex Patterns

```python
SOURCE_BOOK_PATTERNS = [
    r'Codex:\s*([^,.\n]+)',
    r'Index:\s*([^,.\n]+)',
    r'Horus Heresy:\s*Book\s+(\d+)[:\s]*([^,.\n]+)',
    r'White Dwarf\s+(\d+)',
    r'Campaign Book:\s*([^,.\n]+)',
]
```

### Coding Standards Reminders

**[Source: docs/architecture/coding-standards.md]**
- Type hints required for all function signatures
- Docstrings required for all public functions (Google style)
- Constants in UPPER_CASE (FACTIONS, ERAS)
- Use regex for pattern matching
- Handle edge cases gracefully (empty strings, no matches)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None required - all tests passed on first run after linting fixes

### Completion Notes List
- Implemented comprehensive metadata extraction system with keyword-based detection
- Created src/common/constants.py with 60+ factions and 20+ eras from WH40K lore
- Implemented faction aliases for normalization (e.g., "Astra Militarum" → "Imperial Guard")
- Character extraction uses wiki link regex to extract top 5 most mentioned names
- Content type classification: character (3+ names), military, technology, or lore (default)
- Spoiler detection based on edition keywords and recent lore markers
- Source book extraction supports Codex, Index, Horus Heresy, White Dwarf patterns
- All tests passing: 34 unit tests + 6 integration tests = 40 total tests
- 100% code coverage on metadata_extractor.py (90 statements)
- Code passes ruff linting and mypy type checking with --strict
- Integration tests validated with real wiki markdown files from data/markdown-archive/
- Used CHARACTER_DENSITY_THRESHOLD constant to avoid magic numbers
- **Pull Request**: https://github.com/madarasz/wh40k-lore-bot/pull/10

### File List
**New Files Created:**
- src/common/__init__.py
- src/common/constants.py
- src/ingestion/metadata_extractor.py
- tests/unit/test_metadata_extractor.py
- tests/integration/test_metadata_extraction.py

**Modified Files:**
- None (all new implementations)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |
| 2025-12-29 | 1.1 | Implementation completed - all ACs met, tests passing | James (Dev Agent) |

## QA Results
[To be populated by QA agent]

# Story 2.4: Response Formatter with Structured Output & Personality

## Status
Ready for Review

## Epic
Epic 2: Core RAG Query System

## Dependencies
- Story 2.3: Multi-LLM Router (provides `LLMStructuredResponse` Pydantic model)
- Existing structlog infrastructure

## Story
**As a** developer,
**I want** a response formatter that accepts structured LLM outputs and formats them with personality additions, source citations, and smalltalk handling,
**so that** users receive engaging, verifiable responses.

## Acceptance Criteria

### Response Formatter Class
1. `ResponseFormatter` class created in `src/llm/response_formatter.py`

### CLI Response Formatting
2. `format_cli_response()` method implementation:
   - Accepts `llm_response: LLMStructuredResponse` (Pydantic model from LLM)
   - Accepts `language: str` (default: "hu")
   - Returns formatted string for CLI output

### Lore Question Format (smalltalk=false)
3. CLI response format for lore questions:
   ```
   [Answer text from LLM]

   [Personality reply in italic/dim style]

   ðŸ“š ForrÃ¡sok:
   - https://warhammer40k.fandom.com/wiki/Roboute_Guilliman
   - https://warhammer40k.fandom.com/wiki/Ultramarines
   ```

### Smalltalk Format (smalltalk=true)
4. CLI response format for smalltalk:
   ```
   [Personality reply only]
   ```

### Source URL Formatting
5. Source URL formatting:
   - Display full wiki URLs (LLM provides URLs, not article titles)
   - No deduplication needed (LLM handles this)
   - Limit to top 5 URLs in output (prevent clutter)

### Personality Reply Formatting
6. Personality reply formatting:
   - Always display personality_reply
   - Style: italic and dim for visual distinction
   - Positioned after answer, before sources

### Discord Response Stub
7. `format_discord_response()` method (stub for Epic 3):
   - Returns basic text format (Discord Embed formatting in Epic 3)
   - Placeholder implementation for future

### Language Support
8. Hungarian/English language support:
   - "ðŸ“š ForrÃ¡sok:" for Hungarian responses
   - "ðŸ“š Sources:" for English responses
   - Language parameter determines header (not detection from text)

### Testing
9. Unit tests covering:
   - Lore question formatting (smalltalk=false, all fields present)
   - Smalltalk formatting (smalltalk=true, only personality_reply)
   - Source URL display (full URLs)
   - Source limit enforcement (>5 sources)
   - Hungarian language formatting
   - English language formatting
   - Empty sources list (smalltalk case)

## Tasks / Subtasks

- [x] Task 1: Create ResponseFormatter class (AC: 1)
  - [x] Create `src/llm/response_formatter.py`
  - [x] Define `ResponseFormatter` class
  - [x] Add structlog logger
  - [x] Export from `src/llm/__init__.py`

- [x] Task 2: Implement format_cli_response() for lore questions (AC: 2, 3)
  - [x] Accept `LLMStructuredResponse` as input
  - [x] Accept `language` parameter (default: "hu")
  - [x] Format answer text (plain output)
  - [x] Format personality_reply (italic/dim placeholder - actual styling in CLI adapter)
  - [x] Format sources section with emoji header

- [x] Task 3: Implement smalltalk formatting (AC: 4)
  - [x] Detect smalltalk=true case
  - [x] Return only personality_reply for smalltalk
  - [x] Skip answer and sources sections

- [x] Task 4: Implement source URL formatting (AC: 5)
  - [x] Display full wiki URLs
  - [x] Limit to 5 sources maximum
  - [x] Format as bullet list

- [x] Task 5: Add language support (AC: 8)
  - [x] Define language-specific headers (HU: "ForrÃ¡sok", EN: "Sources")
  - [x] Use language parameter to select header
  - [x] Test both languages

- [x] Task 6: Implement format_discord_response() stub (AC: 7)
  - [x] Create placeholder method
  - [x] Return basic text format (reuse CLI format)
  - [x] Add TODO comment for Epic 3 Embed implementation

- [x] Task 7: Write unit tests (AC: 9)
  - [x] Test lore question formatting (smalltalk=false)
  - [x] Test smalltalk formatting (smalltalk=true)
  - [x] Test source URL display
  - [x] Test source limit enforcement (>5 sources)
  - [x] Test Hungarian formatting
  - [x] Test English formatting
  - [x] Test empty sources edge case

## Dev Notes

### Technical Background
- **Structured Output:** Simplifies formatting (no manual parsing)
- **Sources as URLs:** Direct verification (not article titles)
- **Personality Reply:** Adds engagement and character to responses
- **Smalltalk Handling:** Enables natural conversation flow
- **CLI Format:** Simple and readable; Discord format will use Embeds (Epic 3)

### ResponseFormatter Example
```python
from src.llm.structured_output import LLMStructuredResponse
import structlog

logger = structlog.get_logger(__name__)

class ResponseFormatter:
    """Format LLM structured responses for different output targets."""

    HEADERS = {
        "hu": "ðŸ“š ForrÃ¡sok:",
        "en": "ðŸ“š Sources:",
    }
    MAX_SOURCES = 5

    def format_cli_response(
        self,
        llm_response: LLMStructuredResponse,
        language: str = "hu",
    ) -> str:
        """Format structured LLM response for CLI output."""
        if llm_response.smalltalk:
            return llm_response.personality_reply

        parts = []

        # Answer
        if llm_response.answer:
            parts.append(llm_response.answer)

        # Personality reply
        parts.append(f"\n{llm_response.personality_reply}")

        # Sources
        if llm_response.sources:
            header = self.HEADERS.get(language, self.HEADERS["en"])
            sources = llm_response.sources[:self.MAX_SOURCES]
            source_lines = [f"- {str(url)}" for url in sources]
            parts.append(f"\n{header}\n" + "\n".join(source_lines))

        return "\n".join(parts)

    def format_discord_response(
        self,
        llm_response: LLMStructuredResponse,
        language: str = "hu",
    ) -> str:
        """Format structured LLM response for Discord (stub for Epic 3)."""
        # TODO: Epic 3 - Implement Discord Embed formatting
        return self.format_cli_response(llm_response, language)
```

### Output Examples

**Lore Question (Hungarian):**
```
Roboute Guilliman a Birodalom egyik legerÅ‘sebb harcosa Ã©s az Ultramarines
lÃ©giÃ³jÃ¡nak primarchÃ¡ja. A 13. lÃ©giÃ³ alapÃ­tÃ³ja Ã©s vezetÅ‘je...

Az CsÃ¡szÃ¡r vÃ©delme legyen veled, halandÃ³.

ðŸ“š ForrÃ¡sok:
- https://warhammer40k.fandom.com/wiki/Roboute_Guilliman
- https://warhammer40k.fandom.com/wiki/Ultramarines
- https://warhammer40k.fandom.com/wiki/Primarch
```

**Smalltalk:**
```
ÃœdvÃ¶zÃ¶llek a 41. Ã©vezredben! KÃ©szen Ã¡llok vÃ¡laszolni a kÃ©rdÃ©seidre.
```

### Relevant Source Tree
```
src/llm/
â”œâ”€â”€ __init__.py                          # Export ResponseFormatter
â”œâ”€â”€ structured_output.py                 # LLMStructuredResponse (from 2.3)
â”œâ”€â”€ response_formatter.py                # NEW: ResponseFormatter class
tests/unit/
â”œâ”€â”€ test_response_formatter.py           # NEW: ResponseFormatter tests
```

### Testing Strategy
- **Unit Tests:** Test all formatting scenarios with mock LLMStructuredResponse
- **Language Coverage:** Test both Hungarian and English outputs
- **Edge Cases:** Empty sources, >5 sources, smalltalk variations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Story created from Epic 2 | John (PM Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - implementation completed without issues

### Pull Request
https://github.com/madarasz/wh40k-lore-bot/pull/21

### Completion Notes List
- Implemented `ResponseFormatter` class with full type hints and Google-style docstrings
- `format_cli_response()` handles both lore questions and smalltalk responses
- Source URL limiting (MAX_SOURCES=5) implemented with debug logging when truncated
- Language support for Hungarian (default) and English with fallback to English for unknown languages
- `format_discord_response()` stub delegates to CLI format with TODO comment for Epic 3
- All 19 unit tests passing with 100% coverage on `response_formatter.py`
- Full regression suite (387 tests) passing

### File List
- `src/llm/response_formatter.py` (NEW)
- `src/llm/__init__.py` (MODIFIED - added ResponseFormatter export)
- `tests/unit/test_response_formatter.py` (NEW)

## QA Results
_To be populated by QA agent_

---

**Estimated Effort:** 1.5 hours
